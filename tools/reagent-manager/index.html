<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å®éªŒå®¤è¯å“ç®¡ç†ï¼ˆä¸ªäººç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel2:#0f1520;
      --text:#e6edf3; --muted:#9fb0c0; --line:#223043;
      --accent:#6ee7b7; --warn:#fbbf24; --danger:#fb7185; --ok:#60a5fa;
      --chip:#172235; --chip2:#0f1a2b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:linear-gradient(180deg,#070a0f 0%, #0b0f14 100%); color:var(--text);}
    a{color:inherit}
    button,input,select,textarea{font:inherit}
    .app{display:grid; grid-template-columns: 260px 1fr; min-height:100vh;}
    .sidebar{background:rgba(17,24,38,.65); border-right:1px solid var(--line); padding:18px; position:sticky; top:0; height:100vh; backdrop-filter: blur(10px);}
    .brand{display:flex; gap:10px; align-items:center; margin-bottom:14px;}
    .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(circle at 30% 30%, var(--accent), #3b82f6 55%, #111826 100%); box-shadow:var(--shadow);}
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px;}
    .brand .sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .nav{display:flex; flex-direction:column; gap:8px; margin-top:14px;}
    .nav button{
      width:100%; text-align:left; padding:10px 12px; border:1px solid transparent; border-radius:12px;
      background:transparent; color:var(--text); cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .nav button:hover{background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06)}
    .nav button.active{background:rgba(110,231,183,.10); border-color:rgba(110,231,183,.25)}
    .pill{font-size:12px; padding:2px 8px; border-radius:8px; background:rgba(255,255,255,.06); color:var(--muted);}
    .sidecard{margin-top:14px; padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(15,21,32,.55);}
    .sidecard .k{font-size:12px; color:var(--muted)}
    .sidecard .v{font-size:18px; margin-top:4px}
    .content{padding:18px 18px 40px;}
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--line); border-radius:16px;
      background:rgba(17,24,38,.5); backdrop-filter: blur(10px); box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10;
    }
    .search{flex:1; display:flex; gap:10px; align-items:center}
    .search input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:rgba(7,10,15,.55); color:var(--text); outline:none;
    }
    .search input:focus{border-color:rgba(110,231,183,.35)}
    .actions{display:flex; gap:8px; align-items:center}
    .btn{
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05); color:var(--text); cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{background:rgba(110,231,183,.12); border-color:rgba(110,231,183,.25)}
    .btn.danger{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.25)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .grid{display:grid; gap:12px;}
    .cards{grid-template-columns: repeat(4, minmax(0,1fr)); margin-top:14px;}
    @media (max-width:1100px){ .cards{grid-template-columns:repeat(2,minmax(0,1fr));} .app{grid-template-columns: 220px 1fr;} }
    @media (max-width:820px){ .app{grid-template-columns:1fr;} .sidebar{position:relative; height:auto;} .topbar{position:relative; top:0;} .cards{grid-template-columns:1fr;} }
    .card{
      border:1px solid var(--line); border-radius:var(--radius); padding:14px; background:rgba(17,24,38,.45); box-shadow:var(--shadow);
    }
    .card h3{margin:0; font-size:14px}
    .card .big{font-size:28px; margin-top:6px}
    .muted{color:var(--muted)}
    .section{margin-top:14px;}
    .section h2{font-size:16px; margin:0 0 10px 0; letter-spacing:.2px;}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px; border:1px solid var(--line); border-radius:16px; background:rgba(15,21,32,.45);
    }
    .toolbar .group{display:flex; gap:8px; align-items:center;}
    select, .smallinput{
      padding:9px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:rgba(7,10,15,.55); color:var(--text); outline:none;
    }
    .smallinput{min-width:220px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.10);
      background:rgba(23,34,53,.55); cursor:pointer; user-select:none;
      font-size:12px; color:var(--text);
    }
    .chip:hover{border-color:rgba(255,255,255,.18)}
    .chip.on{border-color:rgba(110,231,183,.35); background:rgba(110,231,183,.10)}
    .chip .dot{width:8px;height:8px;border-radius:8px; background:rgba(255,255,255,.35)}
    .chip.system{background:rgba(15,26,43,.6)}
    .chip.neg{border-style:dashed; opacity:.9}
    .tablewrap{margin-top:10px; border:1px solid var(--line); border-radius:16px; overflow:hidden; background:rgba(17,24,38,.35)}
    table{width:100%; border-collapse:collapse;}
    thead th{
      text-align:left; font-size:12px; color:var(--muted); padding:10px 12px;
      background:rgba(15,21,32,.65); border-bottom:1px solid var(--line);
      position:sticky; top:0;
    }
    tbody td{padding:12px; border-bottom:1px solid rgba(34,48,67,.6); vertical-align:top;}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .negqty{background:rgba(251,113,133,.08);} 
    .negqty:hover{background:rgba(251,113,133,.10);}
    .name{font-weight:650}
    .subline{font-size:12px; color:var(--muted); margin-top:4px}
    .badge{
  position:relative;
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px 6px 14px;
  border-radius:8px; /* rounded rectangle */
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:600;
  font-size:12px;
  line-height:1;
  white-space:nowrap;
  overflow:hidden;
}

.badge::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  width:4px; /* left accent bar */
  background:var(--accent, rgba(255,255,255,.22));
  border-top-left-radius:8px;
  border-bottom-left-radius:8px;
}


    .badge.warn{border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.10)}
    .badge.danger{border-color:rgba(251,113,133,.35); background:rgba(251,113,133,.10)}
    .badge.ok{border-color:rgba(96,165,250,.35); background:rgba(96,165,250,.10)}
    .mono{font-family:var(--mono)}
    .rowactions{display:flex; gap:8px; flex-wrap:wrap;}
    .linkbtn{background:transparent; border:1px solid rgba(255,255,255,.12); color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px;}
    .linkbtn:hover{border-color:rgba(255,255,255,.18)}
    details > summary{cursor:pointer; color:var(--muted); font-size:12px;}
    details{margin-top:8px}
    .empty{padding:18px; color:var(--muted); text-align:center}
    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:flex-start; justify-content:center; padding:22px; z-index:30;}
    .modal.on{display:flex;}
    .dialog{width:min(860px, 100%); border:1px solid var(--line); border-radius:18px; background:rgba(17,24,38,.92); box-shadow:var(--shadow); overflow:hidden; max-height: calc(100vh - 44px); display:flex; flex-direction:column;}
    .dialog .head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(34,48,67,.9);}
    .dialog .head h3{margin:0; font-size:14px}
    .dialog .body{padding:16px; overflow:auto;}
    .formgrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;}
    .formgrid .full{grid-column: 1 / -1}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:rgba(7,10,15,.55); color:var(--text); outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .dialog .foot{display:flex; gap:10px; justify-content:flex-end; padding:14px 16px; border-top:1px solid rgba(34,48,67,.9); background:rgba(15,21,32,.6)}
    .toast{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:50;}
    .toast .t{padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(17,24,38,.92); box-shadow:var(--shadow); max-width:360px;}
    .toast .t .title{font-weight:650}
    .kbd{
  display:inline-block;
  padding:2px 6px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  font-size:12px;
  line-height:1.0;
  margin-right:4px;
}
    .split{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .mini{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>å®éªŒå®¤è¯å“ç®¡ç†ï¼ˆä¸ªäººç‰ˆï¼‰</h1>
        <div class="sub">æœ¬åœ°ç¦»çº¿ Â· æ•°æ®å­˜äºæµè§ˆå™¨</div>
      </div>
    </div>

    <div class="nav">
      <button data-route="home" class="active">ä»ªè¡¨ç›˜ <span class="pill" id="pillHome"> </span></button>
      <button data-route="inventory">åº“å­˜ <span class="pill" id="pillInv"> </span></button>
      <button data-route="log">å…¥åº“/é¢†ç”¨ <span class="pill" id="pillLog"> </span></button>
      <button data-route="tags">æ ‡ç­¾ <span class="pill" id="pillTags"> </span></button>
      <button data-route="settings">è®¾ç½®/å¯¼å…¥å¯¼å‡º <span class="pill">JSON/CSV</span></button>
    </div>

    <div class="sidecard">
      <div class="k">å¿«è¿‡æœŸï¼ˆ30å¤©ï¼‰</div>
      <div class="v" id="sideExp">0</div>
      <div class="k" style="margin-top:10px;">ä½åº“å­˜</div>
      <div class="v" id="sideLow">0</div>
    </div>

    <div class="sidecard">
      <div class="k">å¿«æ·é”®</div>
      <div class="hint" style="display:flex; flex-direction:column; gap:8px;">
        <div><span class="kbd">Ctrl</span>+<span class="kbd">K</span> èšç„¦æœç´¢</div>
        <div><span class="kbd">Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">I</span> å…¥åº“</div>
        <div><span class="kbd">Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">U</span> é¢†ç”¨</div>
        <div><span class="kbd">Esc</span> å…³é—­å¼¹çª—</div>
      </div>
    </div>
  </aside>

  <main class="content">
    <div class="topbar">
      <div class="search">
        <input id="globalSearch" placeholder="æœç´¢ï¼šè¯å / ä¸­æ–‡å / åˆ«å / CAS / å‚å®¶ / ç¼–å· / æ‰¹å· /  ä½ç½®..." />
      </div>
      <div class="actions">
        <button class="btn primary" id="btnQuickIn">+ å…¥åº“</button>
        <button class="btn" id="btnQuickUse">é¢†ç”¨</button>
        <button class="btn" id="btnExportCSV">å¯¼å‡ºåº“å­˜CSV</button>
      </div>
    </div>

    <!-- HOME -->
    <section id="view-home" class="view">
      <div class="grid cards">
        <div class="card">
          <h3>æ€»åº“å­˜æ‰¹æ¬¡</h3>
          <div class="big" id="kpiLots">0</div>
          <div class="muted">å¯ç”¨/éš”ç¦»/è¿‡æœŸç­‰å…¨éƒ¨</div>
        </div>
        <div class="card">
          <h3>å¿«è¿‡æœŸï¼ˆâ‰¤30å¤©ï¼‰</h3>
          <div class="big" id="kpiExp30">0</div>
          <div class="muted">å»ºè®®ä¼˜å…ˆä½¿ç”¨æˆ–å¤„ç†</div>
        </div>
        <div class="card">
          <h3>å·²è¿‡æœŸ</h3>
          <div class="big" id="kpiExpired">0</div>
          <div class="muted">è¯·åŠæ—¶æ ‡è®°æŠ¥åºŸ/é”€æ¯</div>
        </div>
        <div class="card">
          <h3>ä½åº“å­˜</h3>
          <div class="big" id="kpiLow">0</div>
          <div class="muted">ä½äºé˜ˆå€¼æˆ–ä¸º0</div>
        </div>
      </div>

      <div class="section">
        <div class="split">
          <h2>å¾…å¤„ç†</h2>
          <div class="mini">ç‚¹å‡»æ¡ç›®å¯è·³è½¬åˆ°åº“å­˜å¹¶è‡ªåŠ¨ç­›é€‰</div>
        </div>
        <div class="tablewrap">
          <table>
            <thead><tr><th>ç±»å‹</th><th>è¯å“/æ‰¹æ¬¡</th><th>ä½ç½®</th><th>åˆ°æœŸ/æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="todoTable"></tbody>
          </table>
          <div id="todoEmpty" class="empty" style="display:none;">æš‚æ— å¾…å¤„ç†é¡¹ ğŸ‰</div>
        </div>
      </div>

      <div class="section">
        <div class="split">
          <h2>æœ€è¿‘è®°å½•</h2>
          <div class="mini">æœ€è¿‘ 20 æ¡å…¥åº“/é¢†ç”¨/è°ƒæ•´</div>
        </div>
        <div class="tablewrap">
          <table>
            <thead><tr><th>æ—¶é—´</th><th>ç±»å‹</th><th>è¯å“</th><th>æ‰¹æ¬¡</th><th>å˜åŒ–</th><th>å¤‡æ³¨</th></tr></thead>
            <tbody id="recentTable"></tbody>
          </table>
          <div id="recentEmpty" class="empty" style="display:none;">è¿˜æ²¡æœ‰ä»»ä½•è®°å½•ã€‚å…ˆç‚¹å³ä¸Šè§’ <b>+ å…¥åº“</b>ã€‚</div>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="view-inventory" class="view" style="display:none;">
      <div class="section">
        <h2>åº“å­˜</h2>
        <div class="toolbar">
          <div class="group">
            <span class="mini">æ ‡ç­¾åŒ¹é…ï¼š</span>
            <select id="tagMode">
              <option value="OR">åŒ…å«ä»»æ„ï¼ˆORï¼‰</option>
              <option value="AND">åŒ…å«å…¨éƒ¨ï¼ˆANDï¼‰</option>
            </select>
          </div>
          <div class="group">
            <span class="mini">çŠ¶æ€ï¼š</span>
            <select id="statusFilter">
              <option value="ALL">å…¨éƒ¨</option>
              <option value="ACTIVE">å¯ç”¨</option>
              <option value="QUAR">éš”ç¦»</option>
              <option value="EXPIRED">å·²è¿‡æœŸ</option>
              <option value="DISPOSED">å·²æŠ¥åºŸ/é”€æ¯</option>
            </select>
          </div>
          <div class="group">
            <span class="mini">æ’åºï¼š</span>
            <select id="sortBy">
              <option value="EXP_ASC">æœ‰æ•ˆæœŸï¼ˆè¿‘â†’è¿œï¼‰</option>
              <option value="EXP_DESC">æœ‰æ•ˆæœŸï¼ˆè¿œâ†’è¿‘ï¼‰</option>
              <option value="USED_DESC">æœ€è¿‘ä½¿ç”¨</option>
              <option value="QTY_ASC">æ•°é‡ï¼ˆå°‘â†’å¤šï¼‰</option>
              <option value="QTY_DESC">æ•°é‡ï¼ˆå¤šâ†’å°‘ï¼‰</option>
            </select>
          </div>
          <div class="group">
            <span class="mini">ä½ç½®ï¼š</span>
            <input class="smallinput" id="locFilter" placeholder="å¦‚ï¼š-20â„ƒ / Freezer2 / Shelf3" />
          </div>
          <div class="group">
            <button class="btn" id="btnClearFilters">æ¸…é™¤ç­›é€‰</button>
          </div>
          <div class="chips full" id="tagChips"></div>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:28%;">è¯å“</th>
                <th style="width:16%;">æ‰¹æ¬¡/æœ‰æ•ˆæœŸ</th>
                <th style="width:12%;">æ•°é‡</th>
                <th style="width:16%;">ä½ç½®</th>
                <th style="width:18%;">æ ‡ç­¾/çŠ¶æ€</th>
                <th style="width:10%;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="invTable"></tbody>
          </table>
          <div id="invEmpty" class="empty" style="display:none;">æ²¡æœ‰åŒ¹é…çš„åº“å­˜ã€‚ä½ å¯ä»¥ <b>+ å…¥åº“</b> æˆ–æ¸…é™¤ç­›é€‰ã€‚</div>
        </div>
      </div>
    </section>

    <!-- LOG -->
    <section id="view-log" class="view" style="display:none;">
      <div class="section">
        <div class="split">
          <h2>å…¥åº“ / é¢†ç”¨ / è°ƒæ•´</h2>
          <div class="mini">å»ºè®®æŠŠâ€œè®°å½•â€å½“ä½œè®°è´¦ï¼šè¶Šå¿«è¶Šå¥½ã€‚</div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div class="card">
            <h3>å¿«é€Ÿå…¥åº“</h3>
            <div class="hint">åˆ›å»ºæˆ–è¡¥å……ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆLotï¼‰ã€‚è¯å“åæ”¯æŒè‡ªåŠ¨è¡¥å…¨ã€‚</div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnOpenIn">+ å…¥åº“</button>
              <button class="btn" id="btnOpenAdj">ç›˜ç‚¹è°ƒæ•´</button>
            </div>
          </div>
          <div class="card">
            <h3>å¿«é€Ÿé¢†ç”¨</h3>
            <div class="hint">é€‰æ‹©ä¸€ä¸ªæ‰¹æ¬¡å¹¶æ‰£å‡æ•°é‡ã€‚å¯é€‰å¡«å†™å®éªŒç”¨é€”/å¤‡æ³¨ã€‚</div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnOpenUse">é¢†ç”¨</button>
              <button class="btn danger" id="btnOpenDisp">æŠ¥åºŸ/é”€æ¯</button>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="split">
          <h2>æµæ°´</h2>
          <div class="mini">
            <button class="btn" id="btnExportTxCSV">å¯¼å‡ºæµæ°´CSV</button>
          </div>
        </div>
        <div class="tablewrap">
          <table>
            <thead><tr><th>æ—¶é—´</th><th>ç±»å‹</th><th>è¯å“</th><th>æ‰¹æ¬¡</th><th>å˜åŒ–</th><th>å¤‡æ³¨</th></tr></thead>
            <tbody id="txTable"></tbody>
          </table>
          <div id="txEmpty" class="empty" style="display:none;">æš‚æ— æµæ°´ã€‚</div>
        </div>
      </div>
    </section>

    <!-- TAGS -->
    <section id="view-tags" class="view" style="display:none;">
      <div class="section">
        <div class="split">
          <h2>æ ‡ç­¾ç®¡ç†</h2>
          <div class="mini">æ”¯æŒï¼šæ–°å»ºã€é‡å‘½åã€åˆå¹¶ã€ç½®é¡¶ã€‚ç³»ç»Ÿæ ‡ç­¾è‡ªåŠ¨ç”Ÿæˆã€‚</div>
        </div>
        <div class="toolbar">
          <div class="group" style="flex:1;">
            <input class="smallinput" id="newTagName" placeholder="æ–°æ ‡ç­¾åï¼ˆå›è½¦åˆ›å»ºï¼‰" style="min-width:260px;" />
            <div style="display:flex; gap:8px; align-items:center;">
            <input id="newTagColorHex" type="text" value="#6ee7b7" placeholder="#RRGGBB" class="smallinput" style="width:140px; max-width:180px;" />
            <input id="newTagColor" type="color" value="#6ee7b7" title="é€‰æ‹©é¢œè‰²" style="width:44px; height:40px; padding:0; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(7,10,15,.55);" />
          
            <button class="btn" id="btnTagAutoColor" type="button" style="padding:10px 12px; height:40px;">éšæœº/è‡ªåŠ¨</button>
          </div>
            <button class="btn primary" id="btnCreateTag">åˆ›å»º</button>
          </div>
          <div class="group">
            <button class="btn" id="btnCleanupTags">æ¸…ç†ç©ºæ ‡ç­¾</button>
          </div>
        </div>

        <div class="tablewrap">
          <table>
            <thead><tr><th>æ ‡ç­¾</th><th>é¢œè‰²</th><th>å…³è”æ•°é‡</th><th>ç½®é¡¶</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="tagTable"></tbody>
          </table>
          <div id="tagEmpty" class="empty" style="display:none;">æš‚æ— è‡ªå®šä¹‰æ ‡ç­¾ã€‚å¯ä»¥åœ¨å…¥åº“/ç¼–è¾‘æ—¶ç›´æ¥è¾“å…¥åˆ›å»ºã€‚</div>
        </div>

        <div class="section">
          <h2>ç³»ç»Ÿæ ‡ç­¾ï¼ˆè‡ªåŠ¨ï¼‰</h2>
          <div class="chips" id="systemChips"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="view" style="display:none;">
      <div class="section">
        <h2>å¤‡ä»½ä¸å¯¼å…¥</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div class="card">
            <h3>å¯¼å‡º JSONï¼ˆæ¨èå¤‡ä»½ï¼‰</h3>
            <div class="hint">åŒ…å«è¯å“ã€æ‰¹æ¬¡ã€æ ‡ç­¾ä¸æµæ°´ã€‚</div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btnExportJSON">å¯¼å‡º JSON</button>
              <button class="btn" id="btnResetAll">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            </div>
          </div>
          <div class="card">
            <h3>å¯¼å…¥ JSON</h3>
            <div class="hint">ä»å¤‡ä»½æ¢å¤ã€‚ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼ˆå¯¼å…¥å‰å»ºè®®å…ˆå¯¼å‡ºï¼‰ã€‚</div>
            <div style="margin-top:10px;">
              <input type="file" id="importFile" accept="application/json" />
              <div style="margin-top:10px;">
                <button class="btn primary" id="btnImportJSON">å¯¼å…¥</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>æ•°æ®å­˜å‚¨è¯´æ˜</h2>
          <div class="card">
            <div class="hint">
              è¯¥å·¥å…·ä¸º<strong>çº¯å‰ç«¯å•æ–‡ä»¶</strong>ï¼šæ‰€æœ‰æ•°æ®é»˜è®¤å­˜æ”¾åœ¨å½“å‰æµè§ˆå™¨çš„ <span class="kbd">localStorage</span>ã€‚
              å»ºè®®å®šæœŸç”¨â€œå¯¼å‡º JSONâ€å¤‡ä»½åˆ°ç¡¬ç›˜æˆ–åŒæ­¥ç›˜ã€‚
              <br/><br/>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODALS -->
<div class="modal" id="modal">
  <div class="dialog">
    <div class="head">
      <h3 id="modalTitle"> </h3>
      <button class="btn" id="btnCloseModal">å…³é—­</button>
    </div>
    <div class="body" id="modalBody"></div>
    <div class="foot" id="modalFoot"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   Minimal Personal Lab Drug Manager
   - LocalStorage persistence
   - Inventory lots + transactions
   - Custom tags (create/rename/merge/pin/cleanup)
   - System tags: expiring/expired/low/opened
   ========================= */

const STORE_KEY = "lab_drug_manager_v1";
const DAYS_EXP_SOON = 30;

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function todayISO(){
  const d = new Date();
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function parseISO(s){
  if(!s) return null;
  const d = new Date(s+"T00:00:00");
  return isNaN(d) ? null : d;
}
function daysBetween(a,b){
  // b - a in days
  return Math.floor((b.getTime()-a.getTime())/86400000);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function toast(title, msg=""){
  const t = document.createElement("div");
  t.className = "t";
  t.innerHTML = `<div class="title">${escapeHtml(title)}</div>${msg?`<div class="hint">${escapeHtml(msg)}</div>`:""}`;
  document.getElementById("toast").appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 2600);
  setTimeout(()=>{ t.remove(); }, 3200);
}

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function downloadText(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

function toCSV(rows){
  const esc = (v)=>{
    if(v===null||v===undefined) return "";
    const s = String(v);
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  };
  const headers = Object.keys(rows[0]||{});
  const lines = [headers.map(esc).join(",")];
  for(const r of rows){
    lines.push(headers.map(h=>esc(r[h])).join(","));
  }
  return lines.join("\n");
}

/* ============ Data Layer ============ */
const defaultState = ()=>{
  return {
    meta:{version:1, createdAt: new Date().toISOString()},
    drugs: [
      // example
      // {id, name, alias, unit, defaultLocation, defaultTags:[], notes}
    ],
    lots: [
      // {id, drugId, lotNo, expDate, openedDate, qty, minQty, unit, location, tags:[], status:"ACTIVE"|"QUAR"|"EXPIRED"|"DISPOSED", updatedAt, lastUsedAt}
    ],
    tx: [
      // {id, timeISO, type:"IN"|"USE"|"ADJ"|"DISP", lotId, qtyDelta, note}
    ],
    tags: [
      // {name, color, pinned:false}
    ],
    ui:{
      route:"home",
      search:"",
      statusFilter:"ALL",
      sortBy:"EXP_ASC",
      locFilter:"",
      tagMode:"OR",
      tagSelected:[],  // positive
      tagExcluded:[]   // negative
    }
  };
};

function load(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const st = JSON.parse(raw);
    // basic migrations
    if(!st.ui) st.ui = defaultState().ui;
    if(!st.tags) st.tags = [];
    if(!st.drugs) st.drugs = [];
    if(!st.lots) st.lots = [];
    if(!st.tx) st.tx = [];
    return st;
  }catch(e){
    console.error(e);
    return defaultState();
  }
}
function save(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}
let state = load();

/* ============ Computed ============ */
const SYSTEM_TAGS = [
  {key:"EXP_SOON", name:"å¿«è¿‡æœŸ", desc:"è·ç¦»åˆ°æœŸâ‰¤30å¤©", color:"#f7b4c5"},
  {key:"EXPIRED",  name:"å·²è¿‡æœŸ", desc:"å·²è¿‡æœŸ", color:"#f38ba8"},
  {key:"LOW_STOCK",name:"ä½åº“å­˜", desc:"æ•°é‡â‰¤é˜ˆå€¼", color:"#f2c98f"},
  {key:"OPENED",   name:"å·²å¼€å°", desc:"å·²è®°å½•å¼€å°æ—¥æœŸ", color:"#b6d7f7"},
];

function getDrug(drugId){
  return state.drugs.find(d=>d.id===drugId) || null;
}
function getLot(lotId){
  return state.lots.find(l=>l.id===lotId) || null;
}

function systemTagsForLot(lot){
  const tags = [];
  const now = new Date();
  const exp = parseISO(lot.expDate);
  if(exp){
    const d = daysBetween(now, exp);
    if(d < 0) tags.push("å·²è¿‡æœŸ");
    else if(d <= DAYS_EXP_SOON) tags.push("å¿«è¿‡æœŸ");
  }
  const qty = Number(lot.qty||0);
  const minQty = Number(lot.minQty||0);
  if(qty <= 0 || (minQty>0 && qty <= minQty)) tags.push("ä½åº“å­˜");
  if(lot.openedDate) tags.push("å·²å¼€å°");
  return tags;
}

function normalizeTagName(s){
  return (s||"").trim();
}

function normalizeHexColor(c){
  c = (c||"").trim();
  if(!c) return "";
  if(!c.startsWith("#")) c = "#"+c;
  const m = /^#([0-9a-fA-F]{6})$/.exec(c);
  return m ? ("#"+m[1].toLowerCase()) : "";
}

const TAG_PALETTE = [
  "#a7f3d0", "#bfdbfe", "#c4b5fd", "#fbcfe8", "#fde68a",
  "#fdba74", "#d9f99d", "#bde0fe", "#e9d5ff", "#fecdd3",
  "#c7f9cc", "#b5e2fa"
];

function nextPaletteColor(){
  const used = new Set((state.tags||[]).map(t=>(t.color||"").toLowerCase()).filter(Boolean));
  for(const c of TAG_PALETTE){
    if(!used.has(c.toLowerCase())) return c;
  }
  // fallback: cycle
  const i = (state.ui?.paletteIdx ?? 0) % TAG_PALETTE.length;
  const c = TAG_PALETTE[i];
  state.ui.paletteIdx = i + 1;
  return c;
}

function randomPaletteColor(){
  const cur = (document.getElementById("newTagColor")?.value || "").toLowerCase();
  const pool = TAG_PALETTE.map(x=>x.toLowerCase());
  if(pool.length===0) return "#6ee7b7";
  let c = pool[Math.floor(Math.random()*pool.length)];
  if(cur && pool.length>1){
    let guard = 0;
    while(c===cur && guard++<10){
      c = pool[Math.floor(Math.random()*pool.length)];
    }
  }
  return c;
}

function refreshNewTagColor(){
  const pick = document.getElementById("newTagColor");
  const hex = document.getElementById("newTagColorHex");
  if(!pick || !hex) return;
  const c = nextPaletteColor();
  pick.value = c;
  hex.value = c;
}

function allCustomTagsSorted(){
  const t = [...state.tags];
  // pinned first, then alpha
  t.sort((a,b)=>{
    if(!!b.pinned !== !!a.pinned) return (b.pinned?1:0)-(a.pinned?1:0);
    return (a.name||"").localeCompare(b.name||"", "zh-Hans-CN");
  });
  return t;
}

function allTagNamesForLot(lot){
  const custom = (lot.tags||[]).map(normalizeTagName).filter(Boolean);
  const sys = systemTagsForLot(lot);
  return [...new Set([...custom, ...sys])];
}

function matchText(lot, q){
  if(!q) return true;
  q = q.toLowerCase();
  const d = getDrug(lot.drugId);

  // search across: drug master + lot fields + tags (custom/system)
  const fields = [
    d?.name, d?.cnName, d?.alias, d?.cas, d?.manufacturer, d?.drugCode, d?.unit, d?.notes,
    lot.lotNo, lot.location, lot.unit, lot.status,
    ...(lot.tags||[]),
    ...systemTagsForLot(lot),
  ].filter(Boolean).join(" ").toLowerCase();

  return fields.includes(q);
}

function matchTags(lot){
  const tags = allTagNamesForLot(lot).map(t=>t.toLowerCase());
  const pos = (state.ui.tagSelected||[]).map(t=>t.toLowerCase());
  const neg = (state.ui.tagExcluded||[]).map(t=>t.toLowerCase());

  // exclude first
  for(const t of neg){
    if(tags.includes(t)) return false;
  }
  if(pos.length===0) return true;
  if(state.ui.tagMode==="AND"){
    return pos.every(t=>tags.includes(t));
  }
  return pos.some(t=>tags.includes(t));
}

function matchStatus(lot){
  const f = state.ui.statusFilter;
  if(f==="ALL") return true;
  const now = new Date();
  const exp = parseISO(lot.expDate);
  const sysExpired = exp ? daysBetween(now, exp) < 0 : false;
  const status = lot.status || "ACTIVE";
  if(f==="EXPIRED"){
    return status==="EXPIRED" || (status!=="DISPOSED" && sysExpired);
  }
  if(f==="DISPOSED") return status==="DISPOSED";
  if(f==="QUAR") return status==="QUAR";
  if(f==="ACTIVE"){
    // treat auto-expired as expired
    return status==="ACTIVE" && !sysExpired;
  }
  return true;
}

function matchLocation(lot){
  const f = (state.ui.locFilter||"").trim().toLowerCase();
  if(!f) return true;
  return (lot.location||"").toLowerCase().includes(f);
}

function filteredLots(){
  const q = (state.ui.search||"").trim().toLowerCase();
  let lots = state.lots.filter(l=>matchText(l,q) && matchTags(l) && matchStatus(l) && matchLocation(l));
  lots = sortLots(lots, state.ui.sortBy);
  return lots;
}

function sortLots(lots, mode){
  const now = new Date();
  const expKey = (l)=>{
    const d = parseISO(l.expDate);
    if(!d) return null;
    return daysBetween(now, d); // smaller means sooner
  };
  const qtyKey = (l)=>Number(l.qty||0);
  const usedKey = (l)=> l.lastUsedAt ? Date.parse(l.lastUsedAt) : 0;

  const copy = [...lots];
  copy.sort((a,b)=>{
    if(mode==="EXP_ASC"){
      const ea = expKey(a), eb = expKey(b);
      if(ea===null && eb===null) return usedKey(b)-usedKey(a);
      if(ea===null) return 1;
      if(eb===null) return -1;
      return ea-eb;
    }
    if(mode==="EXP_DESC"){
      const ea = expKey(a), eb = expKey(b);
      if(ea===null && eb===null) return usedKey(b)-usedKey(a);
      if(ea===null) return -1;
      if(eb===null) return 1;
      return eb-ea;
    }
    if(mode==="QTY_ASC") return qtyKey(a)-qtyKey(b);
    if(mode==="QTY_DESC") return qtyKey(b)-qtyKey(a);
    if(mode==="USED_DESC") return usedKey(b)-usedKey(a);
    return 0;
  });
  return copy;
}

/* ============ UI Routing ============ */
const views = ["home","inventory","log","tags","settings"];
function setRoute(route){
  state.ui.route = route;
  save();
  for(const v of views){
    document.getElementById("view-"+v).style.display = (v===route) ? "" : "none";
    document.querySelectorAll(".nav button").forEach(b=>{
      b.classList.toggle("active", b.dataset.route===route);
    });
  }
  render();
}
document.querySelectorAll(".nav button").forEach(b=>{
  b.addEventListener("click", ()=>setRoute(b.dataset.route));
});

/* ============ Render ============ */
function render(){
  // pills / side KPIs
  const lots = state.lots;
  document.getElementById("pillHome").textContent = " ";
  document.getElementById("pillInv").textContent = String(lots.length);
  document.getElementById("pillLog").textContent = String(state.tx.length);
  document.getElementById("pillTags").textContent = String(state.tags.length);

  const now = new Date();
  const exp30 = lots.filter(l=>{
    const exp = parseISO(l.expDate);
    if(!exp) return false;
    const d = daysBetween(now, exp);
    return d>=0 && d<=DAYS_EXP_SOON && (l.status!=="DISPOSED");
  }).length;
  const expired = lots.filter(l=>{
    const exp = parseISO(l.expDate);
    const isExp = exp ? daysBetween(now, exp)<0 : false;
    return (l.status==="EXPIRED" || (isExp && l.status!=="DISPOSED"));
  }).length;
  const low = lots.filter(l=>{
    const qty = Number(l.qty||0), minQty=Number(l.minQty||0);
    return (l.status!=="DISPOSED") && (qty<=0 || (minQty>0 && qty<=minQty));
  }).length;

  document.getElementById("sideExp").textContent = String(exp30);
  document.getElementById("sideLow").textContent = String(low);

  // global search input
  const gs = document.getElementById("globalSearch");
  if(gs.value !== (state.ui.search||"")) gs.value = state.ui.search||"";

  // route renders
  if(state.ui.route==="home") renderHome();
  if(state.ui.route==="inventory") renderInventory();
  if(state.ui.route==="log") renderLog();
  if(state.ui.route==="tags") renderTags();
  if(state.ui.route==="settings") renderSettings();
}

function renderHome(){
  const now = new Date();
  const lots = state.lots;

  document.getElementById("kpiLots").textContent = String(lots.length);
  const exp30 = lots.filter(l=>{
    const exp = parseISO(l.expDate);
    if(!exp) return false;
    const d = daysBetween(now, exp);
    return d>=0 && d<=DAYS_EXP_SOON && l.status!=="DISPOSED";
  }).length;
  const expired = lots.filter(l=>{
    const exp = parseISO(l.expDate);
    const isExp = exp ? daysBetween(now, exp)<0 : false;
    return (l.status==="EXPIRED" || (isExp && l.status!=="DISPOSED"));
  }).length;
  const low = lots.filter(l=>{
    const qty = Number(l.qty||0), minQty=Number(l.minQty||0);
    return l.status!=="DISPOSED" && (qty<=0 || (minQty>0 && qty<=minQty));
  }).length;

  document.getElementById("kpiExp30").textContent = String(exp30);
  document.getElementById("kpiExpired").textContent = String(expired);
  document.getElementById("kpiLow").textContent = String(low);

  // Todo table: build list of items
  const todos = [];
  for(const lot of lots){
    if(lot.status==="DISPOSED") continue;
    const d = getDrug(lot.drugId);
    const exp = parseISO(lot.expDate);
    if(exp){
      const delta = daysBetween(now, exp);
      if(delta < 0){
        todos.push({type:"å·²è¿‡æœŸ", pri:0, lot, drug:d, info:`å·²è¿‡æœŸ ${Math.abs(delta)} å¤©`});
      }else if(delta <= DAYS_EXP_SOON){
        todos.push({type:"å¿«è¿‡æœŸ", pri:1, lot, drug:d, info:`å‰©ä½™ ${delta} å¤©`});
      }
    }
    const qty = Number(lot.qty||0), minQty=Number(lot.minQty||0);
    if(qty<=0 || (minQty>0 && qty<=minQty)){
      todos.push({type:"ä½åº“å­˜", pri:2, lot, drug:d, info:`${qty} ${escapeHtml(lot.unit||d?.unit||"")}`});
    }
  }
  todos.sort((a,b)=>a.pri-b.pri);

  const tb = document.getElementById("todoTable");
  tb.innerHTML = "";
  const empty = document.getElementById("todoEmpty");
  empty.style.display = todos.length ? "none" : "";
  for(const t of todos.slice(0,50)){
    const lot = t.lot, d = t.drug;
    const expBadge = buildExpiryBadge(lot);
    const tr = document.createElement("tr");
    if(Number(lot.qty||0) < 0) tr.classList.add("negqty");
    tr.innerHTML = `
      <td><span class="badge ${t.type==="å·²è¿‡æœŸ"?"danger":(t.type==="å¿«è¿‡æœŸ"?"warn":"ok")}">${escapeHtml(t.type)}</span></td>
      <td>
        <div class="name">${escapeHtml(d?.name||"(æœªå‘½åè¯å“)")}</div>
        <div class="subline">Lot: <span class="mono">${escapeHtml(lot.lotNo||"-")}</span></div>
      </td>
      <td><span class="mono">${escapeHtml(lot.location||"-")}</span></td>
      <td>${expBadge} <span class="badge">${escapeHtml(t.info)}</span></td>
      <td>
        <div class="rowactions">
          <button class="linkbtn" data-act="jump" data-lot="${lot.id}">æŸ¥çœ‹</button>
          <button class="linkbtn" data-act="use" data-lot="${lot.id}">é¢†ç”¨</button>
          <button class="linkbtn" data-act="edit" data-lot="${lot.id}">ç¼–è¾‘</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  }
  tb.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const lotId = b.dataset.lot;
      if(b.dataset.act==="jump"){
        // set filters to focus this lot by lotNo
        const lot = getLot(lotId);
        if(lot){
          state.ui.route="inventory";
          state.ui.search = lot.lotNo || (getDrug(lot.drugId)?.name||"");
          state.ui.tagSelected=[];
          state.ui.tagExcluded=[];
          save();
          setRoute("inventory");
        }
      }
      if(b.dataset.act==="use") openUseModal(lotId);
      if(b.dataset.act==="edit") openEditLotModal(lotId);
    });
  });

  // recent tx
  const recent = [...state.tx].sort((a,b)=>Date.parse(b.timeISO)-Date.parse(a.timeISO)).slice(0,20);
  const rt = document.getElementById("recentTable");
  rt.innerHTML="";
  document.getElementById("recentEmpty").style.display = recent.length ? "none" : "";
  for(const tx of recent){
    const lot = getLot(tx.lotId);
    const d = lot ? getDrug(lot.drugId) : null;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(tx.timeISO.replace("T"," ").slice(0,19))}</td>
      <td>${escapeHtml(txTypeLabel(tx.type))}</td>
      <td>${escapeHtml(d?.name||"-")}</td>
      <td class="mono">${escapeHtml(lot?.lotNo||"-")}</td>
      <td class="mono">${escapeHtml(fmtDelta(tx.qtyDelta, lot?.unit || d?.unit))}</td>
      <td>${escapeHtml(tx.note||"")}</td>
    `;
    rt.appendChild(tr);
  }
}

function buildExpiryBadge(lot){
  const now = new Date();
  const exp = parseISO(lot.expDate);
  if(!exp) return `<span class="badge">æ— æœ‰æ•ˆæœŸ</span>`;
  const d = daysBetween(now, exp);
  if(d<0) return `<span class="badge danger">å·²è¿‡æœŸ</span>`;
  if(d<=DAYS_EXP_SOON) return `<span class="badge warn">å¿«è¿‡æœŸ</span>`;
  return `<span class="badge ok">æœ‰æ•ˆ</span>`;
}

function renderInventory(){
  // sync controls
  document.getElementById("tagMode").value = state.ui.tagMode||"OR";
  document.getElementById("statusFilter").value = state.ui.statusFilter||"ALL";
  document.getElementById("sortBy").value = state.ui.sortBy||"EXP_ASC";
  document.getElementById("locFilter").value = state.ui.locFilter||"";

  // tag chips (system + custom)
  const chips = document.getElementById("tagChips");
  chips.innerHTML="";
  const makeChip = (name, opts={})=>{
    const on = (state.ui.tagSelected||[]).includes(name);
    const neg = (state.ui.tagExcluded||[]).includes(name);
    const c = document.createElement("div");
    c.className = "chip " + (opts.system?"system ":"") + (on?"on ":"") + (neg?"neg ":"");
    const color = opts.color || "rgba(255,255,255,.35)";
    c.innerHTML = `<span class="dot" style="background:${color}"></span><span>${escapeHtml(name)}</span>`;
    c.title = opts.system ? "ç³»ç»Ÿæ ‡ç­¾ï¼ˆè‡ªåŠ¨ï¼‰" : "è‡ªå®šä¹‰æ ‡ç­¾";
    c.addEventListener("click", (e)=>{
      // cycle: off -> selected -> excluded -> off
      const sel = new Set(state.ui.tagSelected||[]);
      const exc = new Set(state.ui.tagExcluded||[]);
      if(!sel.has(name) && !exc.has(name)){
        sel.add(name);
      }else if(sel.has(name)){
        sel.delete(name); exc.add(name);
      }else{
        exc.delete(name);
      }
      state.ui.tagSelected = [...sel];
      state.ui.tagExcluded = [...exc];
      save(); renderInventory();
    });
    chips.appendChild(c);
  };

  // system tags first
  SYSTEM_TAGS.forEach(t=>makeChip(t.name,{system:true,color:"rgba(255,255,255,.35)"}));
  // custom tags
  allCustomTagsSorted().forEach(t=>makeChip(t.name,{system:false,color:t.color||"rgba(110,231,183,.7)"}));

  // filtered table
  const lots = filteredLots();
  const tbody = document.getElementById("invTable");
  tbody.innerHTML="";
  document.getElementById("invEmpty").style.display = lots.length ? "none" : "";

  for(const lot of lots){
    const d = getDrug(lot.drugId);
    const tags = (lot.tags||[]).slice(0,3);
    const sys = systemTagsForLot(lot).slice(0,2);
    const more = Math.max(0, (lot.tags||[]).length + systemTagsForLot(lot).length - (tags.length+sys.length));
    const expBadge = buildExpiryBadge(lot);
    const statusBadge = lot.status==="QUAR" ? `<span class="badge warn">éš”ç¦»</span>` :
                       lot.status==="DISPOSED" ? `<span class="badge danger">å·²æŠ¥åºŸ</span>` : ``;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div class="name">${escapeHtml(d?.name||"(æœªå‘½åè¯å“)")}</div>
        <div class="subline">ä¸­æ–‡åï¼š${escapeHtml(d?.cnName||"-")} Â· åˆ«åï¼š${escapeHtml(d?.alias||"-")} Â· å•ä½ï¼š${escapeHtml(lot.unit || d?.unit || "-")}</div>
        <details>
          <summary>å±•å¼€è¯¦æƒ…</summary>
          <div class="hint">
            ä¸­æ–‡åï¼š${escapeHtml(d?.cnName||"-")} Â· CASï¼š<span class="mono">${escapeHtml(d?.cas||"-")}</span> Â· å‚å®¶ï¼š${escapeHtml(d?.manufacturer||"-")} Â· ç¼–å·ï¼š<span class="mono">${escapeHtml(d?.drugCode||"-")}</span><br/>
            å¤‡æ³¨ï¼š${escapeHtml(d?.notes||"") || "<span class='muted'>æ— </span>"}<br/>
            å¼€å°ï¼š${escapeHtml(lot.openedDate||"-")} Â· æœ€è¿‘ä½¿ç”¨ï¼š${escapeHtml(lot.lastUsedAt?lot.lastUsedAt.replace("T"," ").slice(0,19):"-")}<br/>
            æ‰¹æ¬¡æ ‡ç­¾ï¼š${escapeHtml((lot.tags||[]).join(", ")||"æ— ")}
          </div>
        </details>
      </td>
      <td>
        <div class="mono">Lot: ${escapeHtml(lot.lotNo||"-")}</div>
        <div class="subline">æœ‰æ•ˆæœŸï¼š${escapeHtml(lot.expDate||"-")}</div>
        <div style="margin-top:8px;">${expBadge} ${statusBadge}</div>
      </td>
      <td class="mono">${escapeHtml(lot.qty ?? 0)} ${escapeHtml(lot.unit || d?.unit || "")} ${Number(lot.qty||0) < 0 ? `<span class="badge danger">è´Ÿåº“å­˜</span>` : ``}</td>
      <td class="mono">${escapeHtml(lot.location||"-")}</td>
      <td>
        ${sys.map(t=>{
          const c = (SYSTEM_TAGS.find(x=>x.name===t)?.color) || "#94a3b8";
          return `<span class="badge" style="--accent:${c};">${escapeHtml(t)}</span>`;
        }).join("")}
        ${tags.map(t=>{
          const c = (state.tags.find(x=>x.name===t)?.color) || "rgba(255,255,255,.14)";
          return `<span class="badge" style="--accent:${c};">${escapeHtml(t)}</span>`;
        }).join("")}
        ${more>0?`<span class="badge">+${more}</span>`:""}
      </td>
      <td>
        <div class="rowactions">
          <button class="linkbtn" data-act="use" data-lot="${lot.id}">é¢†ç”¨</button>
          <button class="linkbtn" data-act="edit" data-lot="${lot.id}">ç¼–è¾‘</button>
          <button class="linkbtn" data-act="more" data-lot="${lot.id}">æ›´å¤š</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const lotId = b.dataset.lot;
      if(b.dataset.act==="use") openUseModal(lotId);
      if(b.dataset.act==="edit") openEditLotModal(lotId);
      if(b.dataset.act==="more") openMoreActions(lotId);
    });
  });
}

function renderLog(){
  // tx table
  const tx = [...state.tx].sort((a,b)=>Date.parse(b.timeISO)-Date.parse(a.timeISO));
  const tbody = document.getElementById("txTable");
  tbody.innerHTML="";
  document.getElementById("txEmpty").style.display = tx.length ? "none" : "";
  for(const t of tx.slice(0,500)){
    const lot = getLot(t.lotId);
    const d = lot ? getDrug(lot.drugId) : null;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${escapeHtml(t.timeISO.replace("T"," ").slice(0,19))}</td>
      <td>${escapeHtml(txTypeLabel(t.type))}</td>
      <td>${escapeHtml(d?.name||"-")}</td>
      <td class="mono">${escapeHtml(lot?.lotNo||"-")}</td>
      <td class="mono">${escapeHtml(fmtDelta(t.qtyDelta, lot?.unit || d?.unit))}</td>
      <td>${escapeHtml(t.note||"")}</td>
    `;
    tbody.appendChild(tr);
  }
}

function renderTags(){
  // system chips
  const sys = document.getElementById("systemChips");
  sys.innerHTML="";
  refreshNewTagColor();
  for(const t of SYSTEM_TAGS){
    const c = document.createElement("div");
    c.className = "chip system";
    c.innerHTML = `<span class="dot" style="background:${escapeHtml(t.color||"#94a3b8")}"></span><span>${escapeHtml(t.name)}</span><span class="mini">Â· ${escapeHtml(t.desc)}</span>`;
    sys.appendChild(c);
  }

  // tag table
  const tbody = document.getElementById("tagTable");
  tbody.innerHTML="";
  const tags = allCustomTagsSorted();
  document.getElementById("tagEmpty").style.display = tags.length ? "none" : "";
  for(const tag of tags){
    const cnt = countTagUsage(tag.name);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="badge" style="--accent:${escapeHtml(tag.color||"#6ee7b7")};">${escapeHtml(tag.name)}</span></td>
      <td>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input type="text" value="${escapeHtml(tag.color||"#6ee7b7")}" data-act="hex" data-tag="${escapeHtml(tag.name)}"
            class="smallinput" style="width:140px; max-width:180px;" />
          <input type="color" value="${escapeHtml(tag.color||"#6ee7b7")}" data-act="color" data-tag="${escapeHtml(tag.name)}"
            style="width:44px; height:34px; padding:0; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(7,10,15,.55);" />
        </div>
      </td>
      <td class="mono">${cnt}</td>
      <td>
        <button class="linkbtn" data-act="pin" data-tag="${escapeHtml(tag.name)}">${tag.pinned?"å–æ¶ˆç½®é¡¶":"ç½®é¡¶"}</button>
      </td>
      <td>
        <div class="rowactions">
          <button class="linkbtn" data-act="rename" data-tag="${escapeHtml(tag.name)}">é‡å‘½å</button>
          <button class="linkbtn" data-act="merge" data-tag="${escapeHtml(tag.name)}">åˆå¹¶åˆ°â€¦</button>
          <button class="linkbtn" data-act="del" data-tag="${escapeHtml(tag.name)}">åˆ é™¤</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // tag actions
  tbody.querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      const name = b.dataset.tag;
      if(b.dataset.act==="pin"){
        const t = state.tags.find(x=>x.name===name);
        if(t){ t.pinned = !t.pinned; save(); renderTags(); renderInventory(); }
      }
      if(b.dataset.act==="rename") openRenameTag(name);
      if(b.dataset.act==="merge") openMergeTag(name);
      if(b.dataset.act==="del") deleteTag(name);
    });
  });

  // color editing (picker)
  tbody.querySelectorAll('input[data-act="color"]').forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const name = inp.dataset.tag;
      const t = state.tags.find(x=>x.name===name);
      if(!t) return;
      const v = (inp.value||"#6ee7b7").toLowerCase();
      t.color = v;

      const hex = tbody.querySelector(`input[data-act="hex"][data-tag="${name.replaceAll('"','&quot;')}"]`);
      if(hex) hex.value = v;

      save();
      renderInventory(); // refresh chips
    });
  });

  // color editing (hex)
  tbody.querySelectorAll('input[data-act="hex"]').forEach(inp=>{
    const apply = ()=>{
      const name = inp.dataset.tag;
      const t = state.tags.find(x=>x.name===name);
      if(!t) return;
      const v = normalizeHexColor(inp.value);
      if(!v){
        toast("é¢œè‰²æ ¼å¼æ— æ•ˆ", "è¯·è¾“å…¥ #RRGGBB");
        inp.value = t.color || "#6ee7b7";
        return;
      }
      t.color = v;

      const pick = tbody.querySelector(`input[data-act="color"][data-tag="${name.replaceAll('"','&quot;')}"]`);
      if(pick) pick.value = v;

      inp.value = v;
      save();
      renderInventory();
    };
    inp.addEventListener("change", apply);
    inp.addEventListener("blur", apply);
  });
}

function renderSettings(){
  // nothing dynamic currently
}

/* ============ Tag Usage ============ */
function countTagUsage(tagName){
  let n=0;
  for(const lot of state.lots){
    if((lot.tags||[]).includes(tagName)) n++;
  }
  for(const d of state.drugs){
    if((d.defaultTags||[]).includes(tagName)) n++;
  }
  return n;
}

function ensureTagExists(name, color=null){
  name = normalizeTagName(name);
  if(!name) return;
  const existing = state.tags.find(t=>t.name===name);
  const c = normalizeHexColor(color);
  if(!existing){
    state.tags.push({name, color: c || "#6ee7b7", pinned:false});
  }else{
    if(c) existing.color = c;
  }
}

/* ============ Transactions ============ */
function txTypeLabel(t){
  if(t==="IN") return "å…¥åº“";
  if(t==="USE") return "é¢†ç”¨";
  if(t==="ADJ") return "è°ƒæ•´";
  if(t==="DISP") return "æŠ¥åºŸ/é”€æ¯";
  return t;
}
function fmtDelta(delta, unit){
  const u = unit ? (" "+unit) : "";
  if(delta>0) return `+${delta}${u}`;
  return `${delta}${u}`;
}
function addTx(type, lotId, qtyDelta, note){
  state.tx.push({id:uid("tx"), timeISO:new Date().toISOString(), type, lotId, qtyDelta:Number(qtyDelta||0), note: note||""});
  const lot = getLot(lotId);
  if(lot){
    lot.updatedAt = new Date().toISOString();
    if(type==="USE") lot.lastUsedAt = new Date().toISOString();
  }
  save();
}

/* ============ CRUD: Drugs/Lots ============ */
function upsertDrugByName(name, alias, unit, notes, cnName, cas, manufacturer, drugCode){
  name = normalizeTagName(name);
  if(!name) throw new Error("è¯å“åä¸èƒ½ä¸ºç©º");
  let d = state.drugs.find(x=>x.name===name);
  if(!d){
    d = {id:uid("drug"), name, cnName:cnName||"", cas:cas||"", manufacturer:manufacturer||"", drugCode:drugCode||"", alias:alias||"", unit:unit||"", defaultLocation:"", defaultTags:[], notes:notes||""};
    state.drugs.push(d);
  }else{
    if(alias!==undefined) d.alias = alias||d.alias||"";
    if(unit!==undefined) d.unit = unit||d.unit||"";
    if(notes!==undefined) d.notes = notes||d.notes||"";
    if(cnName!==undefined) d.cnName = cnName||d.cnName||"";
    if(cas!==undefined) d.cas = cas||d.cas||"";
    if(manufacturer!==undefined) d.manufacturer = manufacturer||d.manufacturer||"";
    if(drugCode!==undefined) d.drugCode = drugCode||d.drugCode||"";
  }
  return d;
}

function createLot(drugId, lot){
  const d = getDrug(drugId);
  if(!d) throw new Error("æ‰¾ä¸åˆ°è¯å“");
  const l = {
    id: uid("lot"),
    drugId,
    lotNo: lot.lotNo||"",
    expDate: lot.expDate||"",
    openedDate: lot.openedDate||"",
    qty: Number(lot.qty||0),
    minQty: (isFinite(Number(lot.minQty||0)) ? Math.max(0, Number(lot.minQty||0)) : 0),
    unit: lot.unit || d.unit || "",
    location: lot.location || d.defaultLocation || "",
    tags: (lot.tags||[]).map(normalizeTagName).filter(Boolean),
    status: lot.status || "ACTIVE",
    updatedAt: new Date().toISOString(),
    lastUsedAt: ""
  };
  // ensure custom tags exist
  l.tags.forEach(t=>ensureTagExists(t));
  state.lots.push(l);
  save();
  return l;
}

function updateLot(lotId, patch){
  const l = getLot(lotId);
  if(!l) throw new Error("æ‰¾ä¸åˆ°æ‰¹æ¬¡");
  Object.assign(l, patch);
  l.qty = Number(l.qty||0);
  if(!isFinite(l.qty)) l.qty = 0;
  l.minQty = Number(l.minQty||0);
  if(!isFinite(l.minQty) || l.minQty < 0) l.minQty = 0;
  l.tags = (l.tags||[]).map(normalizeTagName).filter(Boolean);
  l.updatedAt = new Date().toISOString();
  l.tags.forEach(t=>ensureTagExists(t));
  save();
}

/* ============ Modal Helpers ============ */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const modalFoot = document.getElementById("modalFoot");

function closeModal(){
  modal.classList.remove("on");
  modalTitle.textContent = "";
  modalBody.innerHTML = "";
  modalFoot.innerHTML = "";
}
document.getElementById("btnCloseModal").addEventListener("click", closeModal);

function openModal(title, bodyHTML, footHTML){
  modalTitle.textContent = title;
  modalBody.innerHTML = bodyHTML;
  modalFoot.innerHTML = footHTML;
  modal.classList.add("on");
  // focus first input
  setTimeout(()=>{
    const el = modalBody.querySelector("input,select,textarea,button");
    if(el) el.focus();
  }, 50);
}

/* ============ Modals: In / Use / Adj / Dispose / Edit ============ */
function buildTagInput(id, preset=[]){
  const opts = allCustomTagsSorted().map(t=>`<option value="${escapeHtml(t.name)}"></option>`).join("");
  const val = preset.join(", ");
  const dlId = `taglist_${id}`;
  return `
    <label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼›å¯ç›´æ¥è¾“å…¥æ–°æ ‡ç­¾ï¼‰</label>
    <input list="${dlId}" id="${id}" type="text" value="${escapeHtml(val)}" placeholder="å¦‚ï¼šæŠ—ç”Ÿç´ , Project-A, å¸¸ç”¨" />
    <datalist id="${dlId}">${opts}</datalist>
    <div class="hint">æç¤ºï¼šç‚¹å‡»åº“å­˜é¡µæ ‡ç­¾å¯ç­›é€‰ï¼›æ ‡ç­¾æ”¯æŒç½®é¡¶/åˆå¹¶ã€‚</div>
  `;
}

function parseTagInput(s){
  return (s||"").split(",").map(x=>normalizeTagName(x)).filter(Boolean);
}

function openInModal(){
  const drugs = [...state.drugs].sort((a,b)=>a.name.localeCompare(b.name,"zh-Hans-CN"));
  const datalist = drugs.map(d=>`<option value="${escapeHtml(d.name)}"></option>`).join("");

  openModal("å…¥åº“ï¼ˆåˆ›å»º/è¡¥å……æ‰¹æ¬¡ï¼‰", `
    <div class="formgrid">
      <div class="full">
        <label>è¯å“å</label>
        <input id="inDrug" list="druglist" type="text" placeholder="å¦‚ï¼šAmpicillin" />
        <datalist id="druglist">${datalist}</datalist>
        <div class="hint">è‹¥è¯å“ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºï¼ˆå¯åç»­åœ¨ç¼–è¾‘é‡Œè¡¥å……åˆ«å/å¤‡æ³¨ï¼‰ã€‚</div>
      </div>
      <div>
        <label>åˆ«åï¼ˆå¯é€‰ï¼‰</label>
        <input id="inAlias" type="text" placeholder="å¦‚ï¼šAmp" />
      </div>
      <div>
        <label>å•ä½ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inUnit" type="text" placeholder="å¦‚ï¼šmL / mg / vial" />
      </div>
      <div>
        <label>ä¸­æ–‡åç§°ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inCnName" type="text" placeholder="å¦‚ï¼šæ°¨è‹„è¥¿æ—" />
      </div>
      <div>
        <label>CAS å·ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inCAS" type="text" placeholder="å¦‚ï¼š69-53-4" />
      </div>
      <div>
        <label>å‚å®¶ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inMfg" type="text" placeholder="å¦‚ï¼šSigma / Thermo / è‡ªé…" />
      </div>
      <div>
        <label>è¯ç‰©ç¼–å·ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inCode" type="text" placeholder="å¦‚ï¼šå†…éƒ¨ç¼–å· / Catalog#" />
      </div>

      <div>
        <label>æ‰¹å· Lotï¼ˆå¯é€‰ï¼‰</label>
        <input id="inLotNo" type="text" placeholder="å¦‚ï¼šLOT2026-01" />
      </div>
      <div>
        <label>æœ‰æ•ˆæœŸï¼ˆå¯é€‰ï¼‰</label>
        <input id="inExp" type="date" />
      </div>
      <div>
        <label>å¼€å°æ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
        <input id="inOpen" type="date" />
      </div>
      <div>
        <label>æ•°é‡</label>
        <input id="inQty" type="number" step="any" value="1" />
      </div>
      <div>
        <label>ä½åº“å­˜é˜ˆå€¼ï¼ˆå¯é€‰ï¼‰</label>
        <input id="inMin" type="number" step="any" value="0" />
      </div>
      <div class="full">
        <label>ä½ç½®</label>
        <input id="inLoc" type="text" placeholder="å¦‚ï¼š-20â„ƒ / Freezer2 / Shelf3 / BoxA" />
      </div>
      <div class="full">${buildTagInput("inTags")}</div>
      <div class="full">
        <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="inNote" placeholder="å¦‚ï¼šç”¨äºqPCRï¼›é¿å…‰ï¼›æ‰¹æ¬¡æ•ˆä»·åä½ç­‰"></textarea>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnSubmitIn">å…¥åº“</button>
  `);

  document.getElementById("inExp").value = "";
  document.getElementById("inOpen").value = "";

  document.getElementById("btnSubmitIn").addEventListener("click", ()=>{
    try{
      const name = document.getElementById("inDrug").value.trim();
      const alias = document.getElementById("inAlias").value.trim();
      const unit = document.getElementById("inUnit").value.trim();
      const note = document.getElementById("inNote").value.trim();
      const cnName = document.getElementById("inCnName").value.trim();
      const cas = document.getElementById("inCAS").value.trim();
      const manufacturer = document.getElementById("inMfg").value.trim();
      const drugCode = document.getElementById("inCode").value.trim();
      const lotNo = document.getElementById("inLotNo").value.trim();
      const expDate = document.getElementById("inExp").value;
      const openedDate = document.getElementById("inOpen").value;
      const qty = Number(document.getElementById("inQty").value||0);
      const minQty = Number(document.getElementById("inMin").value||0);
      const location = document.getElementById("inLoc").value.trim();
      const tags = parseTagInput(document.getElementById("inTags").value);

      let finalName = name;
      const existing = state.drugs.find(x=>x.name===name);
      if(existing && cas && existing.cas && (existing.cas.trim() !== cas.trim())){
        const createNew = confirm(`æ£€æµ‹åˆ°åŒåè¯å“â€œ${name}â€å·²å­˜åœ¨ï¼Œä½†CASä¸åŒï¼š
- ç°æœ‰ï¼š${existing.cas}
- æ–°å¢ï¼š${cas}

æ˜¯å¦åˆ›å»ºä¸€ä¸ªæ–°çš„è¯å“æ¡ç›®ï¼Ÿï¼ˆå»ºè®®ï¼šåŒåä¸åŒCASåˆ†å¼€ç®¡ç†ï¼‰`);
        if(createNew){
          finalName = `${name} (CAS:${cas})`;
          let k = 2;
          while(state.drugs.some(x=>x.name===finalName)){
            finalName = `${name} (CAS:${cas})-${k++}`;
          }
        }
      }
      const d = upsertDrugByName(finalName, alias, unit, note, cnName, cas, manufacturer, drugCode);
      const lot = createLot(d.id, {lotNo, expDate, openedDate, qty, minQty, unit: unit||d.unit, location, tags, status:"ACTIVE"});
      addTx("IN", lot.id, qty, note);
      closeModal();
      toast("å…¥åº“æˆåŠŸ", `${d.name} Â· Lot ${lot.lotNo||"-"} +${qty}${lot.unit?(" "+lot.unit):""}`);
      render();
    }catch(e){
      toast("å…¥åº“å¤±è´¥", e.message||String(e));
    }
  });
}

function openUseModal(lotId=null){
  const lots = sortLots(state.lots.filter(l=>l.status!=="DISPOSED"), "USED_DESC");
  const options = lots.map(l=>{
    const d = getDrug(l.drugId);
    return `<option value="${l.id}">${escapeHtml(d?.name||"-")} Â· Lot ${escapeHtml(l.lotNo||"-")} Â· ${escapeHtml(l.qty)} ${escapeHtml(l.unit||d?.unit||"")} Â· ${escapeHtml(l.location||"")}</option>`;
  }).join("");

  openModal("é¢†ç”¨ï¼ˆæ‰£å‡æ•°é‡ï¼‰", `
    <div class="formgrid">
      <div class="full">
        <label>é€‰æ‹©æ‰¹æ¬¡</label>
        <select id="useLot">${options}</select>
      </div>
      <div>
        <label>é¢†ç”¨æ•°é‡</label>
        <input id="useQty" type="number" step="any" value="1" />
        <div class="hint">ä¼šä»å½“å‰æ•°é‡ä¸­æ‰£å‡</div>
      </div>
      <div>
        <label>ç”¨é€”/å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
        <input id="useNote" type="text" placeholder="å¦‚ï¼šWBï¼›Mouse#12ï¼›Project-A" />
      </div>
      <div class="full">
        ${buildTagInput("useAddTags")}
        <div class="hint">æ­¤å¤„æ ‡ç­¾ä¼š<strong>è¿½åŠ åˆ°è¯¥æ‰¹æ¬¡</strong>ï¼ˆé€‚åˆè®°å½•â€œå¾…æ›¿æ¢/æ•ˆä»·åä½â€ç­‰æ‰¹æ¬¡çŠ¶æ€ï¼‰ã€‚</div>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnSubmitUse">ç¡®è®¤é¢†ç”¨</button>
  `);

  if(lotId) document.getElementById("useLot").value = lotId;

  // preset qty to 1 but clamp if needed
  document.getElementById("btnSubmitUse").addEventListener("click", ()=>{
    try{
      const id = document.getElementById("useLot").value;
      const lot = getLot(id);
      if(!lot) throw new Error("æ‰¾ä¸åˆ°æ‰¹æ¬¡");
      const qty = Number(document.getElementById("useQty").value||0);
      if(!isFinite(qty) || qty<=0) throw new Error("é¢†ç”¨æ•°é‡éœ€ > 0");
      if(qty > Number(lot.qty||0)) {
        // allow but warn
        if(!confirm(`é¢†ç”¨æ•°é‡(${qty}) > å½“å‰åº“å­˜(${lot.qty})ï¼Œä»è¦ç»§ç»­å—ï¼Ÿï¼ˆä¼šå˜ä¸ºè´Ÿæ•°ï¼‰`)) return;
      }
      const note = document.getElementById("useNote").value.trim();
      const addTags = parseTagInput(document.getElementById("useAddTags").value);
      updateLot(id, { qty: Number(lot.qty||0) - qty, tags: [...new Set([...(lot.tags||[]), ...addTags])] });
      addTx("USE", id, -qty, note);
      const after = getLot(id);
      if(after && Number(after.qty||0) < 0){
        toast("è­¦å‘Šï¼šåº“å­˜ä¸ºè´Ÿ", "å»ºè®®å°½å¿«ç”¨â€œç›˜ç‚¹è°ƒæ•´â€ä¿®æ­£æ•°é‡ã€‚");
      }
      closeModal();
      toast("é¢†ç”¨å·²è®°å½•", `${getDrug(lot.drugId)?.name||""} -${qty}${lot.unit?(" "+lot.unit):""}`);
      render();
    }catch(e){
      toast("é¢†ç”¨å¤±è´¥", e.message||String(e));
    }
  });
}

function openAdjustModal(){
  const lots = sortLots(state.lots.filter(l=>l.status!=="DISPOSED"), "EXP_ASC");
  const options = lots.map(l=>{
    const d = getDrug(l.drugId);
    return `<option value="${l.id}">${escapeHtml(d?.name||"-")} Â· Lot ${escapeHtml(l.lotNo||"-")} Â· å½“å‰ ${escapeHtml(l.qty)} ${escapeHtml(l.unit||d?.unit||"")}</option>`;
  }).join("");

  openModal("ç›˜ç‚¹è°ƒæ•´ï¼ˆè®¾ç½®ä¸ºç›®æ ‡æ•°é‡ï¼‰", `
    <div class="formgrid">
      <div class="full">
        <label>é€‰æ‹©æ‰¹æ¬¡</label>
        <select id="adjLot">${options}</select>
      </div>
      <div>
        <label>ç›®æ ‡æ•°é‡ï¼ˆç›˜ç‚¹åå®é™…ï¼‰</label>
        <input id="adjTarget" type="number" step="any" value="0" />
      </div>
      <div>
        <label>å¤‡æ³¨ï¼ˆå»ºè®®å¡«å†™åŸå› ï¼‰</label>
        <input id="adjNote" type="text" placeholder="å¦‚ï¼šç›˜ç‚¹ï¼›æŸè€—ï¼›è½¬ç§»æœªè®°å½•ç­‰" />
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnSubmitAdj">ç¡®è®¤è°ƒæ•´</button>
  `);

  // auto fill target with current qty when lot changes
  const sel = document.getElementById("adjLot");
  const target = document.getElementById("adjTarget");
  const syncTarget = ()=>{
    const lot = getLot(sel.value);
    if(lot) target.value = String(lot.qty??0);
  };
  sel.addEventListener("change", syncTarget);
  syncTarget();

  document.getElementById("btnSubmitAdj").addEventListener("click", ()=>{
    try{
      const id = sel.value;
      const lot = getLot(id);
      if(!lot) throw new Error("æ‰¾ä¸åˆ°æ‰¹æ¬¡");
      const newQty = Number(target.value||0);
      if(!isFinite(newQty)) throw new Error("æ•°é‡ä¸åˆæ³•");
      const delta = newQty - Number(lot.qty||0);
      const note = document.getElementById("adjNote").value.trim();
      updateLot(id, {qty:newQty});
      addTx("ADJ", id, delta, note || "ç›˜ç‚¹è°ƒæ•´");
      closeModal();
      toast("å·²è°ƒæ•´", `å˜åŒ– ${fmtDelta(delta, lot.unit || getDrug(lot.drugId)?.unit)}`);
      render();
    }catch(e){
      toast("è°ƒæ•´å¤±è´¥", e.message||String(e));
    }
  });
}

function openDisposeModal(){
  const lots = sortLots(state.lots.filter(l=>l.status!=="DISPOSED"), "EXP_ASC");
  const options = lots.map(l=>{
    const d = getDrug(l.drugId);
    return `<option value="${l.id}">${escapeHtml(d?.name||"-")} Â· Lot ${escapeHtml(l.lotNo||"-")} Â· ${escapeHtml(l.qty)} ${escapeHtml(l.unit||d?.unit||"")}</option>`;
  }).join("");

  openModal("æŠ¥åºŸ/é”€æ¯ï¼ˆå°†çŠ¶æ€ç½®ä¸ºDISPOSEDï¼‰", `
    <div class="formgrid">
      <div class="full">
        <label>é€‰æ‹©æ‰¹æ¬¡</label>
        <select id="dispLot">${options}</select>
      </div>
      <div class="full">
        <label>åŸå› /å¤‡æ³¨ï¼ˆå¿…å¡«ï¼‰</label>
        <input id="dispNote" type="text" placeholder="å¦‚ï¼šè¿‡æœŸï¼›æ±¡æŸ“ï¼›å¤±æ´»ï¼›ç ´æŸç­‰" />
      </div>
      <div class="full">
        <div class="hint">æç¤ºï¼šæŠ¥åºŸä¸ä¼šåˆ é™¤æ•°æ®ï¼›å¯ç”¨äºå®¡è®¡ä¸å¤ç›˜ã€‚</div>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn danger" id="btnSubmitDisp">ç¡®è®¤æŠ¥åºŸ/é”€æ¯</button>
  `);

  document.getElementById("btnSubmitDisp").addEventListener("click", ()=>{
    try{
      const id = document.getElementById("dispLot").value;
      const lot = getLot(id);
      if(!lot) throw new Error("æ‰¾ä¸åˆ°æ‰¹æ¬¡");
      const note = document.getElementById("dispNote").value.trim();
      if(!note) throw new Error("åŸå› /å¤‡æ³¨å¿…å¡«");
      updateLot(id, {status:"DISPOSED"});
      addTx("DISP", id, 0, note);
      closeModal();
      toast("å·²æŠ¥åºŸ/é”€æ¯", `${getDrug(lot.drugId)?.name||""} Â· Lot ${lot.lotNo||"-"}`);
      render();
    }catch(e){
      toast("æ“ä½œå¤±è´¥", e.message||String(e));
    }
  });
}

function openEditLotModal(lotId){
  const lot = getLot(lotId);
  if(!lot){ toast("æ‰¾ä¸åˆ°æ‰¹æ¬¡"); return; }
  const d = getDrug(lot.drugId);

  openModal("ç¼–è¾‘æ‰¹æ¬¡", `
    <div class="formgrid">
      <div class="full">
        <div class="hint">è¯å“ï¼š<b>${escapeHtml(d?.name||"-")}</b>ï¼ˆå¦‚éœ€æ”¹è¯åï¼Œè¯·åœ¨å…¥åº“æ—¶åˆ›å»ºæ–°çš„è¯å“ï¼Œæˆ–ç›´æ¥æ”¹è¯å“åä¼šå½±å“åŒååŒ¹é…ã€‚ï¼‰</div>
      </div>
      <div>
        <label>æ‰¹å· Lot</label>
        <input id="edLotNo" type="text" value="${escapeHtml(lot.lotNo||"")}" />
      </div>
      <div>
        <label>çŠ¶æ€</label>
        <select id="edStatus">
          <option value="ACTIVE">å¯ç”¨</option>
          <option value="QUAR">éš”ç¦»</option>
          <option value="EXPIRED">æ ‡è®°è¿‡æœŸ</option>
          <option value="DISPOSED">å·²æŠ¥åºŸ/é”€æ¯</option>
        </select>
      </div>
      <div>
        <label>æœ‰æ•ˆæœŸ</label>
        <input id="edExp" type="date" value="${escapeHtml(lot.expDate||"")}" />
      </div>
      <div>
        <label>å¼€å°æ—¥æœŸ</label>
        <input id="edOpen" type="date" value="${escapeHtml(lot.openedDate||"")}" />
      </div>
      <div>
        <label>æ•°é‡</label>
        <input id="edQty" type="number" step="any" value="${escapeHtml(lot.qty??0)}" />
      </div>
      <div>
        <label>ä½åº“å­˜é˜ˆå€¼</label>
        <input id="edMin" type="number" step="any" value="${escapeHtml(lot.minQty??0)}" />
      </div>
      <div class="full">
        <label>å•ä½</label>
        <input id="edUnit" type="text" value="${escapeHtml(lot.unit || d?.unit || "")}" />
      </div>
      <div class="full">
        <label>ä½ç½®</label>
        <input id="edLoc" type="text" value="${escapeHtml(lot.location||"")}" />
      </div>
      <div class="full">${buildTagInput("edTags", lot.tags||[])}</div>
      <div class="full">
        <label>è¯å“ä¸­æ–‡åç§°ï¼ˆå¯é€‰ï¼‰</label>
        <input id="edCnName" type="text" value="${escapeHtml(d?.cnName||"")}" />
      </div>
      <div class="full">
        <label>CAS å·ï¼ˆå¯é€‰ï¼‰</label>
        <input id="edCAS" type="text" value="${escapeHtml(d?.cas||"")}" />
      </div>
      <div class="full">
        <label>å‚å®¶ï¼ˆå¯é€‰ï¼‰</label>
        <input id="edMfg" type="text" value="${escapeHtml(d?.manufacturer||"")}" />
      </div>
      <div class="full">
        <label>è¯ç‰©ç¼–å·ï¼ˆå¯é€‰ï¼‰</label>
        <input id="edCode" type="text" value="${escapeHtml(d?.drugCode||"")}" />
      </div>
      <div class="full">
        <label>è¯å“åˆ«åï¼ˆå¯é€‰ï¼Œå†™åˆ°è¯å“ä¸»æ•°æ®ï¼‰</label>
        <input id="edAlias" type="text" value="${escapeHtml(d?.alias||"")}" />
      </div>
      <div class="full">
        <label>è¯å“å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œå†™åˆ°è¯å“ä¸»æ•°æ®ï¼‰</label>
        <textarea id="edDrugNotes">${escapeHtml(d?.notes||"")}</textarea>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnSubmitEdit">ä¿å­˜</button>
  `);

  document.getElementById("edStatus").value = lot.status || "ACTIVE";

  document.getElementById("btnSubmitEdit").addEventListener("click", ()=>{
    try{
      const patch = {
        lotNo: document.getElementById("edLotNo").value.trim(),
        status: document.getElementById("edStatus").value,
        expDate: document.getElementById("edExp").value,
        openedDate: document.getElementById("edOpen").value,
        qty: Number(document.getElementById("edQty").value||0),
        minQty: Number(document.getElementById("edMin").value||0),
        unit: document.getElementById("edUnit").value.trim(),
        location: document.getElementById("edLoc").value.trim(),
        tags: parseTagInput(document.getElementById("edTags").value),
      };
      updateLot(lotId, patch);
      // update drug master alias/notes
      if(d){
        d.cnName = document.getElementById("edCnName").value.trim();
        d.cas = document.getElementById("edCAS").value.trim();
        d.manufacturer = document.getElementById("edMfg").value.trim();
        d.drugCode = document.getElementById("edCode").value.trim();
        d.alias = document.getElementById("edAlias").value.trim();
        d.notes = document.getElementById("edDrugNotes").value.trim();
      }
      save();
      closeModal();
      toast("å·²ä¿å­˜", "æ‰¹æ¬¡ä¸è¯å“ä¿¡æ¯å·²æ›´æ–°");
      render();
    }catch(e){
      toast("ä¿å­˜å¤±è´¥", e.message||String(e));
    }
  });
}

function openMoreActions(lotId){
  const lot = getLot(lotId);
  const d = lot ? getDrug(lot.drugId) : null;
  if(!lot) return;

  openModal("æ›´å¤šæ“ä½œ", `
    <div class="card">
      <div class="name">${escapeHtml(d?.name||"-")}</div>
      <div class="subline">Lot: <span class="mono">${escapeHtml(lot.lotNo||"-")}</span> Â· ${escapeHtml(lot.qty)} ${escapeHtml(lot.unit||d?.unit||"")}</div>
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn primary" id="maUse">é¢†ç”¨</button>
        <button class="btn" id="maAdj">ç›˜ç‚¹è°ƒæ•´</button>
        <button class="btn danger" id="maZero">è®¾ä¸º0ï¼ˆè°ƒæ•´ï¼‰</button>
        <button class="btn" id="maEdit">ç¼–è¾‘</button>
        <button class="btn danger" id="maDisp">æŠ¥åºŸ/é”€æ¯</button>
      </div>
      <div class="hint" style="margin-top:12px;">æç¤ºï¼šä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨åº“å­˜é¡µç”¨â€œæ ‡ç­¾ç­›é€‰â€å¿«é€Ÿå®šä½åŒç±»è¯ã€‚</div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å…³é—­</button>
  `);

  document.getElementById("maUse").addEventListener("click", ()=>{ closeModal(); openUseModal(lotId); });
  document.getElementById("maAdj").addEventListener("click", ()=>{ closeModal(); openAdjustModal(); });
  document.getElementById("maZero").addEventListener("click", ()=>{
    const l = getLot(lotId);
    if(!l) return;
    const unit = l.unit || getDrug(l.drugId)?.unit;
    const delta = 0 - Number(l.qty||0);
    if(!confirm(`ç¡®è®¤å°†è¯¥æ‰¹æ¬¡æ•°é‡è®¾ä¸º0ï¼Ÿï¼ˆä¼šç”Ÿæˆä¸€æ¡â€œè°ƒæ•´â€æµæ°´ï¼Œå˜åŒ–ä¸º ${fmtDelta(delta, unit)}ï¼‰`)) return;
    updateLot(lotId, {qty:0});
    addTx("ADJ", lotId, delta, "ä¸€é”®å½’é›¶ï¼ˆè°ƒæ•´ï¼‰");
    closeModal();
    toast("å·²è®¾ä¸º0", `å˜åŒ– ${fmtDelta(delta, unit)}`);
    render();
  });
  document.getElementById("maEdit").addEventListener("click", ()=>{ closeModal(); openEditLotModal(lotId); });
  document.getElementById("maDisp").addEventListener("click", ()=>{ closeModal(); openDisposeModal(); });
}

/* ============ Tag Operations ============ */
function openRenameTag(oldName){
  openModal("é‡å‘½åæ ‡ç­¾", `
    <div class="formgrid">
      <div class="full">
        <label>åŸæ ‡ç­¾</label>
        <input type="text" value="${escapeHtml(oldName)}" disabled />
      </div>
      <div class="full">
        <label>æ–°æ ‡ç­¾å</label>
        <input id="rnNew" type="text" value="${escapeHtml(oldName)}" />
        <div class="hint">ä¼šåŒæ­¥æ›´æ–°æ‰€æœ‰æ‰¹æ¬¡ä¸è¯å“é»˜è®¤æ ‡ç­¾ã€‚</div>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnDoRename">ç¡®è®¤</button>
  `);

  document.getElementById("btnDoRename").addEventListener("click", ()=>{
    try{
      const nn = normalizeTagName(document.getElementById("rnNew").value);
      if(!nn) throw new Error("æ–°æ ‡ç­¾åä¸èƒ½ä¸ºç©º");
      if(nn===oldName){ closeModal(); return; }
      if(SYSTEM_TAGS.some(t=>t.name===nn)) throw new Error("ä¸èƒ½ä¸ç³»ç»Ÿæ ‡ç­¾é‡å");
      // update tags list
      const t = state.tags.find(x=>x.name===oldName);
      if(t) t.name = nn;
      // update lots/drugs
      for(const l of state.lots){
        l.tags = (l.tags||[]).map(x=>x===oldName?nn:x);
      }
      for(const d of state.drugs){
        d.defaultTags = (d.defaultTags||[]).map(x=>x===oldName?nn:x);
      }
      // dedupe tags array if needed
      state.tags = dedupeTags(state.tags);
      save();
      closeModal();
      toast("å·²é‡å‘½å", `${oldName} â†’ ${nn}`);
      render();
    }catch(e){
      toast("å¤±è´¥", e.message||String(e));
    }
  });
}

function dedupeTags(tags){
  const map = new Map();
  for(const t of tags){
    const name = normalizeTagName(t.name);
    if(!name) continue;
    if(!map.has(name)) map.set(name, {...t, name});
    else{
      // merge pinned/color preference
      const ex = map.get(name);
      ex.pinned = ex.pinned || t.pinned;
      ex.color = ex.color || t.color;
    }
  }
  return [...map.values()];
}

function openMergeTag(fromName){
  const opts = allCustomTagsSorted().filter(t=>t.name!==fromName).map(t=>`<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`).join("");
  openModal("åˆå¹¶æ ‡ç­¾", `
    <div class="formgrid">
      <div class="full">
        <label>å°†æ ‡ç­¾</label>
        <input type="text" value="${escapeHtml(fromName)}" disabled />
      </div>
      <div class="full">
        <label>åˆå¹¶åˆ°</label>
        <select id="mgTo">${opts}</select>
        <div class="hint">åˆå¹¶åï¼šæ‰€æœ‰ä½¿ç”¨ <b>${escapeHtml(fromName)}</b> çš„åœ°æ–¹ä¼šæ”¹ä¸ºç›®æ ‡æ ‡ç­¾ï¼Œå¹¶åˆ é™¤åŸæ ‡ç­¾ã€‚</div>
      </div>
    </div>
  `, `
    <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
    <button class="btn primary" id="btnDoMerge">ç¡®è®¤åˆå¹¶</button>
  `);

  document.getElementById("btnDoMerge").addEventListener("click", ()=>{
    try{
      const toName = document.getElementById("mgTo").value;
      if(!toName) throw new Error("è¯·é€‰æ‹©ç›®æ ‡æ ‡ç­¾");
      // replace in lots/drugs
      for(const l of state.lots){
        l.tags = (l.tags||[]).map(x=>x===fromName?toName:x);
        l.tags = [...new Set(l.tags)];
      }
      for(const d of state.drugs){
        d.defaultTags = (d.defaultTags||[]).map(x=>x===fromName?toName:x);
        d.defaultTags = [...new Set(d.defaultTags)];
      }
      // remove from tags list
      state.tags = state.tags.filter(t=>t.name!==fromName);
      save();
      closeModal();
      toast("å·²åˆå¹¶", `${fromName} â†’ ${toName}`);
      render();
    }catch(e){
      toast("åˆå¹¶å¤±è´¥", e.message||String(e));
    }
  });
}

function deleteTag(name){
  if(!confirm(`åˆ é™¤æ ‡ç­¾â€œ${name}â€ï¼Ÿï¼ˆä¼šä»æ‰€æœ‰æ‰¹æ¬¡/è¯å“ä¸­ç§»é™¤è¯¥æ ‡ç­¾ï¼‰`)) return;
  state.tags = state.tags.filter(t=>t.name!==name);
  for(const l of state.lots){
    l.tags = (l.tags||[]).filter(x=>x!==name);
  }
  for(const d of state.drugs){
    d.defaultTags = (d.defaultTags||[]).filter(x=>x!==name);
  }
  save();
  toast("å·²åˆ é™¤æ ‡ç­¾", name);
  render();
}

function cleanupEmptyTags(){
  const used = new Set();
  for(const l of state.lots) (l.tags||[]).forEach(t=>used.add(t));
  for(const d of state.drugs) (d.defaultTags||[]).forEach(t=>used.add(t));
  const before = state.tags.length;
  state.tags = state.tags.filter(t=>used.has(t.name));
  save();
  toast("æ¸…ç†å®Œæˆ", `åˆ é™¤ç©ºæ ‡ç­¾ ${before - state.tags.length} ä¸ª`);
  render();
}

/* ============ Export / Import ============ */
function exportInventoryCSV(){
  const rows = state.lots.map(l=>{
    const d = getDrug(l.drugId);
    return {
      drug_name: d?.name||"",
      alias: d?.alias||"",
      cn_name: d?.cnName||"",
      cas: d?.cas||"",
      manufacturer: d?.manufacturer||"",
      drug_code: d?.drugCode||"",
      lot_no: l.lotNo||"",
      exp_date: l.expDate||"",
      opened_date: l.openedDate||"",
      qty: l.qty??0,
      unit: l.unit || d?.unit || "",
      min_qty: l.minQty??0,
      location: l.location||"",
      status: l.status||"ACTIVE",
      tags_custom: (l.tags||[]).join(";"),
      tags_system: systemTagsForLot(l).join(";"),
      last_used_at: l.lastUsedAt||"",
      updated_at: l.updatedAt||"",
      drug_notes: d?.notes||"",
    };
  });
  downloadText(`inventory_${todayISO()}.csv`, "\ufeff"+toCSV(rows), "text/csv;charset=utf-8");
  toast("å·²å¯¼å‡ºåº“å­˜CSV");
}

function exportTxCSV(){
  const rows = [...state.tx].sort((a,b)=>Date.parse(a.timeISO)-Date.parse(b.timeISO)).map(t=>{
    const lot = getLot(t.lotId);
    const d = lot ? getDrug(lot.drugId) : null;
    return {
      time: t.timeISO,
      type: txTypeLabel(t.type),
      drug_name: d?.name||"",
      cn_name: d?.cnName||"",
      cas: d?.cas||"",
      manufacturer: d?.manufacturer||"",
      drug_code: d?.drugCode||"",
      lot_no: lot?.lotNo||"",
      delta: t.qtyDelta,
      unit: lot?.unit || d?.unit || "",
      note: t.note||"",
      location: lot?.location||"",
    };
  });
  downloadText(`transactions_${todayISO()}.csv`, "\ufeff"+toCSV(rows), "text/csv;charset=utf-8");
  toast("å·²å¯¼å‡ºæµæ°´CSV");
}

function exportJSON(){
  downloadText(`lab_drug_manager_backup_${todayISO()}.json`, JSON.stringify(state, null, 2), "application/json");
  toast("å·²å¯¼å‡ºJSONå¤‡ä»½");
}

function normalizeImportedState(obj){
  const base = defaultState();
  const st = obj && typeof obj === "object" ? obj : {};
  st.drugs = Array.isArray(st.drugs) ? st.drugs : [];
  st.lots  = Array.isArray(st.lots)  ? st.lots  : [];
  st.tx    = Array.isArray(st.tx)    ? st.tx    : [];
  st.tags  = Array.isArray(st.tags)  ? st.tags  : [];
  st.meta  = st.meta && typeof st.meta==="object" ? st.meta : base.meta;
  st.ui    = st.ui && typeof st.ui==="object" ? {...base.ui, ...st.ui} : {...base.ui};

  for(const d of st.drugs){
    d.id = d.id || uid("drug");
    d.name = (d.name||"").trim();
    d.cnName = d.cnName||"";
    d.cas = d.cas||"";
    d.manufacturer = d.manufacturer||"";
    d.drugCode = d.drugCode||"";
    d.alias = d.alias||"";
    d.unit = d.unit||"";
    d.notes = d.notes||"";
    d.defaultLocation = d.defaultLocation||"";
    d.defaultTags = Array.isArray(d.defaultTags) ? d.defaultTags.map(normalizeTagName).filter(Boolean) : [];
  }
  st.drugs = st.drugs.filter(d=>d.name);

  for(const l of st.lots){
    l.id = l.id || uid("lot");
    l.drugId = l.drugId || "";
    l.lotNo = l.lotNo||"";
    l.expDate = l.expDate||"";
    l.openedDate = l.openedDate||"";
    l.qty = Number(l.qty||0); if(!isFinite(l.qty)) l.qty = 0;
    l.minQty = Number(l.minQty||0); if(!isFinite(l.minQty) || l.minQty<0) l.minQty = 0;
    l.unit = l.unit||"";
    l.location = l.location||"";
    l.tags = Array.isArray(l.tags) ? l.tags.map(normalizeTagName).filter(Boolean) : [];
    l.status = l.status || "ACTIVE";
    l.updatedAt = l.updatedAt || new Date().toISOString();
    l.lastUsedAt = l.lastUsedAt || "";
  }

  // normalize tag list from lots/drugs
  const tagMap = new Map();
  for(const t of st.tags){
    const name = normalizeTagName(t.name);
    if(!name) continue;
    if(!tagMap.has(name)) tagMap.set(name, {name, color: t.color||"#6ee7b7", pinned: !!t.pinned});
    else{
      const ex = tagMap.get(name);
      ex.pinned = ex.pinned || !!t.pinned;
      ex.color = ex.color || t.color;
    }
  }
  st.tags = [...tagMap.values()];

  for(const l of st.lots){
    (l.tags||[]).forEach(t=>ensureTagExists(t));
  }
  for(const d of st.drugs){
    (d.defaultTags||[]).forEach(t=>ensureTagExists(t));
  }

  for(const t of st.tx){
    t.id = t.id || uid("tx");
    t.timeISO = t.timeISO || new Date().toISOString();
    t.type = t.type || "ADJ";
    t.lotId = t.lotId || "";
    t.qtyDelta = Number(t.qtyDelta||0); if(!isFinite(t.qtyDelta)) t.qtyDelta = 0;
    t.note = t.note||"";
  }
  return st;
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || typeof obj !== "object") throw new Error("JSONæ ¼å¼ä¸æ­£ç¡®");
      const st = normalizeImportedState(obj);

      // referential integrity
      const drugIds = new Set(st.drugs.map(d=>d.id));
      st.lots = st.lots.filter(l=>drugIds.has(l.drugId));
      const lotIds = new Set(st.lots.map(l=>l.id));
      st.tx = st.tx.filter(t=>lotIds.has(t.lotId));

      state = st;
      save();
      toast("å¯¼å…¥æˆåŠŸ", "å·²æ¢å¤æ•°æ®ï¼ˆå·²è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±å­—æ®µï¼‰");
      closeModal();
      setRoute(state.ui.route || "home");
    }catch(e){
      toast("å¯¼å…¥å¤±è´¥", e.message||String(e));
    }
  };
  reader.readAsText(file);
}

function resetAll(){
  if(!confirm("ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚å»ºè®®å…ˆå¯¼å‡ºJSONå¤‡ä»½ã€‚")) return;
  state = defaultState();
  save();
  toast("å·²æ¸…ç©º");
  setRoute("home");
}

/* ============ Events ============ */
document.getElementById("globalSearch").addEventListener("input", (e)=>{
  state.ui.search = e.target.value;
  save();
  // re-render only current view if heavy
  render();
});

document.getElementById("btnQuickIn").addEventListener("click", openInModal);
document.getElementById("btnQuickUse").addEventListener("click", ()=>openUseModal(null));
document.getElementById("btnExportCSV").addEventListener("click", exportInventoryCSV);

document.getElementById("btnOpenIn").addEventListener("click", openInModal);
document.getElementById("btnOpenUse").addEventListener("click", ()=>openUseModal(null));
document.getElementById("btnOpenAdj").addEventListener("click", openAdjustModal);
document.getElementById("btnOpenDisp").addEventListener("click", openDisposeModal);

document.getElementById("btnExportTxCSV").addEventListener("click", exportTxCSV);

document.getElementById("tagMode").addEventListener("change", (e)=>{ state.ui.tagMode=e.target.value; save(); renderInventory(); });
document.getElementById("statusFilter").addEventListener("change", (e)=>{ state.ui.statusFilter=e.target.value; save(); renderInventory(); });
document.getElementById("sortBy").addEventListener("change", (e)=>{ state.ui.sortBy=e.target.value; save(); renderInventory(); });
document.getElementById("locFilter").addEventListener("input", (e)=>{ state.ui.locFilter=e.target.value; save(); renderInventory(); });

document.getElementById("btnClearFilters").addEventListener("click", ()=>{
  state.ui.tagSelected=[]; state.ui.tagExcluded=[];
  state.ui.statusFilter="ALL"; state.ui.sortBy="EXP_ASC"; state.ui.locFilter="";
  save(); renderInventory();
});


// tag color picker <-> hex sync
(function(){
  const pick = document.getElementById("newTagColor");
  const hex = document.getElementById("newTagColorHex");
  if(!pick || !hex) return;
  const syncFromPicker = ()=>{ hex.value = pick.value.toLowerCase(); };
  const syncFromHex = ()=>{
    const v = normalizeHexColor(hex.value);
    if(v){ pick.value = v; hex.value = v; }
  };
  pick.addEventListener("input", syncFromPicker);
  hex.addEventListener("change", syncFromHex);
  hex.addEventListener("blur", syncFromHex);
  syncFromPicker();
})();

// auto/random tag color
(function(){
  const btn = document.getElementById("btnTagAutoColor");
  const pick = document.getElementById("newTagColor");
  const hex = document.getElementById("newTagColorHex");
  if(!btn || !pick || !hex) return;
  btn.addEventListener("click", ()=>{
    const c = randomPaletteColor() || nextPaletteColor();
    pick.value = c;
    hex.value = c;
  });
})();
document.getElementById("btnCreateTag").addEventListener("click", ()=>{
  const name = normalizeTagName(document.getElementById("newTagName").value);
  let color = normalizeHexColor(document.getElementById("newTagColorHex").value) || normalizeHexColor(document.getElementById("newTagColor").value);
  if(!color) color = nextPaletteColor();
  if(!name){ toast("æ ‡ç­¾åä¸èƒ½ä¸ºç©º"); return; }
  if(SYSTEM_TAGS.some(t=>t.name===name)){ toast("ä¸èƒ½ä¸ç³»ç»Ÿæ ‡ç­¾é‡å"); return; }
  ensureTagExists(name, color);
  // set color explicitly
  const t = state.tags.find(x=>x.name===name); if(t) t.color=color;
  save();
  document.getElementById("newTagName").value="";
  toast("å·²åˆ›å»ºæ ‡ç­¾", name);
  render();
});
document.getElementById("newTagName").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){ e.preventDefault(); document.getElementById("btnCreateTag").click(); }
});
document.getElementById("btnCleanupTags").addEventListener("click", cleanupEmptyTags);

document.getElementById("btnExportJSON").addEventListener("click", exportJSON);
document.getElementById("btnResetAll").addEventListener("click", resetAll);
document.getElementById("btnImportJSON").addEventListener("click", ()=>{
  const f = document.getElementById("importFile").files[0];
  if(!f){ toast("è¯·é€‰æ‹©JSONæ–‡ä»¶"); return; }
  importJSON(f);
});

document.getElementById("btnExportTxCSV").addEventListener("click", exportTxCSV);

window.addEventListener("keydown", (e)=>{
  const t = e.target;
  const isTyping = t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="SELECT" || t.isContentEditable);
  if(e.key==="Escape"){ closeModal(); return; }
  if(isTyping) return;

  const ctrl = e.ctrlKey || e.metaKey; // macOS âŒ˜
  if(ctrl && (e.key==="k" || e.key==="K")){
    e.preventDefault();
    document.getElementById("globalSearch").focus();
    return;
  }
  if(ctrl && e.shiftKey && (e.key==="i" || e.key==="I")){
    e.preventDefault();
    openInModal();
    return;
  }
  if(ctrl && e.shiftKey && (e.key==="u" || e.key==="U")){
    e.preventDefault();
    openUseModal(null);
    return;
  }
});

/* initial */
setRoute(state.ui.route || "home");

/* expose for inline buttons in modal foot */
window.closeModal = closeModal;
</script>
</body>
</html>
