<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç»†èƒå†»å­˜ç®¡ç†ç³»ç»Ÿ_v2.1</title>
    <style>
        /* ========= å…¨å±€æ ·å¼å®šä¹‰ ========= */
        :root { --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f; --warning: #faad14; --bg: #f5f7fa; --dark: #001529; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); }
        
        /* ========= ä¾§è¾¹æ æ ·å¼ ========= */
        .sidebar { width: 240px; background: var(--dark); color: white; padding: 20px; display: flex; flex-direction: column; }
        .logo { font-size: 20px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 8px; }
        .box-list { flex: 1; overflow-y: auto; }
        .box-item { padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; background: #112a45; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .box-item:hover { border-color: #999; }
        .box-item.active { background: var(--primary); border-color: #40a9ff; }
        .box-info { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .box-tag { opacity: 0.5; font-size: 10px; margin-left: 5px; }
        .box-settings .row { display:flex; gap:10px; }
        .box-settings .field { flex:1; }
        .btn-rename-box { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:6px; background:rgba(255,255,255,0.06); color:#e6f4ff; cursor:pointer; user-select:none; }
        .btn-rename-box:hover { background:rgba(255,255,255,0.12); }
        .btn-delete-box { padding: 4px 8px; margin-left: 8px; border-radius: 4px; color: #aaa; font-weight: bold; font-size: 14px; line-height: 1; transition: 0.2s; }
        .btn-delete-box:hover { background: var(--danger); color: white; }

        /* ========= ä¸»å·¥ä½œåŒºæ ·å¼ ========= */
        .main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow: hidden; position: relative; }
        
        /* å¤´éƒ¨æœç´¢æ ä¸æŒ‰é’®ç»„ */
        .header { display: flex; align-items: center; gap: 15px; position: relative; z-index: 1000; }
        .search-wrapper { flex: 1; position: relative; }
        .search-bar { width: 100%; padding: 12px 15px; border: 1px solid #d9d9d9; border-radius: 8px; outline: none; box-sizing: border-box; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.3s; }
        .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-height: 400px; overflow-y: auto; margin-top: 5px; display: none; }
        .search-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f0f7ff; }
        .loc-tag { font-size: 11px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #666; }
        .data-btns { display: flex; gap: 10px; }
        .btn-ghost { background: white; border: 1px solid #d9d9d9; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

        /* å†…å®¹åŒºåŸŸå¸ƒå±€ */
        .content { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        
        /* ç½‘æ ¼è§†å›¾å®¹å™¨ (æ”¯æŒæ¨ªå‘æ»šåŠ¨é€‚é…ä¸åŒè§„æ ¼) */
        .box-view { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: auto; flex: 1; text-align: center; display: flex; justify-content: center; align-items: flex-start;  position: relative; }
        .grid { display: grid; gap: 6px; margin: 0 auto; width: fit-content; }
        
        /* å•ä¸ªç»†èƒæ ¼å­æ ·å¼ */
        .cell {
            width: 48px; height: 48px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-size: 10px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start;
            padding: 4px; box-sizing: border-box;
            cursor: pointer; background: #fff; transition: all 0.2s; position: relative;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
        }

        .cell .cell-label { font-size: 9px; opacity: 0.75; line-height: 1.1; }
        .cell .cell-name { font-size: 10px; font-weight: 700; line-height: 1.15; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cell .cell-meta { font-size: 9px; opacity: 0.85; line-height: 1.1; }
        /* å ç”¨çŠ¶æ€ (é¢œè‰²ç”±JSåŠ¨æ€ç”Ÿæˆè¦†ç›–) */
        .cell.occupied { border-color: transparent; color: #333; font-weight: 600; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
        /* äº¤äº’çŠ¶æ€: æ‚¬åœ/æ‹–æ‹½/é€‰ä¸­/é«˜äº® */
        .cell.occupied:hover { cursor: grab; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .cell.occupied:active { cursor: grabbing; }
        .cell.drag-over { border: 2px dashed var(--primary); background: #e6f7ff !important; }
        .cell.selected { border: 2px solid var(--primary) !important; box-shadow: 0 0 0 3px rgba(24,144,255,0.2); z-index: 5; transform: scale(1.05); }
        .cell.highlight-target { animation: highlight-jump 1s infinite alternate; border: 2px solid var(--warning) !important; z-index: 10; }
        @keyframes highlight-jump { 0% { transform: scale(1); box-shadow: 0 0 0px var(--warning); } 100% { transform: scale(1.15); box-shadow: 0 0 20px var(--warning); } }

        /* å³ä¾§æ“ä½œé¢æ¿æ ·å¼ */
        .panel { width: 340px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

/* ========= Notion / macOS é£æ ¼è®¾ç½®å¡ç‰‡ ========= */
.settings-toggle {
    position: absolute;
    top: 12px;
    left: 12px;
    display: none;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: #111827;
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.settings-toggle:hover { box-shadow: 0 10px 26px rgba(0,0,0,0.10); }
.settings-toggle:active { transform: translateY(1px); }

#btn-toggle-settings{ z-index: 10; }

.settings-card {
    width: min(360px, calc(100% - 24px));
    padding: 14px 14px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 12px 30px rgba(0,0,0,0.10);
}
/* é¿å…è®¾ç½®å¡ç‰‡ä¸å·¦ä¸Šè§’æŒ‰é’®é‡å  */
.box-view .settings-card { margin-top: 56px; }

.settings-header {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
}
.settings-title {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 4px;
}
.settings-title h3 { margin: 0; font-size: 14px; }
.settings-title .sub {
    font-size: 12px;
    color: #6b7280;
    font-weight: 400;
}
.settings-divider { height: 1px; background: rgba(0,0,0,0.06); margin: 10px 0; }

.setting-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
    margin-bottom: 12px;
}
.setting-item label { font-size: 12px; color: #374151; font-weight: 600; margin: 0; }
.setting-hint { font-size: 12px; color: #6b7280; line-height: 1.4; margin-top: 2px; }

/* ç»Ÿä¸€è¾“å…¥æ§ä»¶æ›´åƒ macOS/Notion */
select, input[type="number"], input[type="text"] {
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.10);
    background: #fff;
    color: #111827;
    outline: none;
}
select { padding: 10px; }
select:focus, input:focus {
    border-color: rgba(24,144,255,0.55);
    box-shadow: 0 0 0 4px rgba(24,144,255,0.14);
}

.settings-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: flex-start;
    flex-wrap: wrap;
}
        input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #d9d9d9; border-radius: 6px; box-sizing: border-box; }
        .inventory-stats { padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #91d5ff; background: #e6f7ff; transition: 0.3s; }
        .stats-danger { background: #fff1f0; border-color: #ffa39e; color: var(--danger); animation: shake 0.5s; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-save:hover { background: #40a9ff; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    
/* ========= æ–°å»ºå®¹å™¨ï¼šæ¨¡æ€è¾“å…¥æ¡† ========= */
.modal-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.35);
  display:none; align-items:center; justify-content:center;
  z-index:2000;
}
.modal{
  width:min(420px, calc(100% - 24px));
  background:#fff;
  border-radius:14px;
  box-shadow:0 18px 60px rgba(0,0,0,0.22);
  border:1px solid rgba(0,0,0,0.08);
  overflow:hidden;
}
.modal-header{
  padding:14px 16px 10px;
  display:flex; align-items:flex-start; gap:10px;
}
.modal-icon{
  width:34px; height:34px; border-radius:10px;
  background:rgba(24,144,255,0.10);
  display:flex; align-items:center; justify-content:center;
  font-size:18px;
  flex:0 0 auto;
}
.modal-title{
  font-size:14px; font-weight:800; margin:0; color:#111827;
}
.modal-sub{
  margin-top:4px; font-size:12px; color:#6b7280; line-height:1.45;
}
.modal-body{ padding:0 16px 12px; }
.modal-body label{ font-size:12px; color:#374151; font-weight:700; display:block; margin:10px 0 6px; }
.modal-body input[type="text"]{
  width:100%; padding:10px 12px; border-radius:10px;
  border:1px solid rgba(0,0,0,0.12);
  box-sizing:border-box;
}
.modal-body input[type="text"]:focus{
  border-color: rgba(24,144,255,0.55);
  box-shadow: 0 0 0 4px rgba(24,144,255,0.14);
  outline:none;
}
.modal-footer{
  padding:12px 16px 14px;
  display:flex; justify-content:flex-end; gap:10px;
  border-top:1px solid rgba(0,0,0,0.06);
}
.btn-modal{
  padding:10px 12px; border-radius:10px; cursor:pointer;
  font-size:13px; border:1px solid rgba(0,0,0,0.12);
  background:#fff;
}
.btn-modal:hover{ border-color: rgba(24,144,255,0.55); color: var(--primary); }
.btn-modal-primary{
  background: var(--primary); color:#fff; border:none;
}
.btn-modal-primary:hover{ background:#40a9ff; color:#fff; }
.modal-hint{
  margin-top:8px; font-size:12px; color:#6b7280;
}
.modal-error{
  margin-top:8px; font-size:12px; color: var(--danger);
  display:none;
}


/* ========= ä½åº“å­˜é¢„è­¦åˆ—è¡¨ï¼šæ›´æ¸…æ™°çš„æ¡ç›®æ ·å¼ ========= */
.warn-item{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid rgba(0,0,0,0.06);
  border-radius:10px;
  background: rgba(250, 173, 20, 0.08);
  margin-bottom:8px;
}
.warn-name{
  font-weight:800; color:#111827;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.warn-sub{
  font-size:12px; color:#6b7280; margin-top:2px;
}
.warn-left{ min-width:0; display:flex; flex-direction:column; }
.warn-count{
  flex:0 0 auto;
  font-weight:900;
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  background:#fff;
  border:1px solid rgba(0,0,0,0.10);
  color:#111827;
}

/* ========= è‡ªå®šä¹‰æ ‡ç­¾ï¼šæ¨¡æ€è¾“å…¥æ¡† ========= */
#label-modal-overlay .modal-icon{ background: rgba(82,196,26,0.12); }


/* label modal clear button */
#label-clear{ color: var(--danger); }
#label-clear:hover{ border-color: rgba(255,77,79,0.55); }

</style>
</head>
<body>

<div class="sidebar">
    <div class="logo">ğŸ§ª ç»†èƒå†»å­˜ç®¡ç†_v2.1</div>
    <div id="box-list" class="box-list"></div>
    <div style="padding-top:15px; border-top:1px solid #333;">
        <select id="new-box-specs" style="width:100%; margin-bottom:10px; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" >
            <option value="9,9">è§„æ ¼: 9 x 9 (81æ ¼)</option>
            <option value="10,10">è§„æ ¼: 10 x 10 (100æ ¼)</option>
            <option value="8,12" selected>è§„æ ¼: 96å­”æ¿ (8è¡Œx12åˆ—)</option>
                    <option value="custom">è§„æ ¼: è‡ªå®šä¹‰...</option>
        </select>
        <div id="custom-spec-fields" style="display:none; margin-bottom:10px;">
            <div style="display:flex; gap:8px;">
                <input id="custom-rows" type="number" min="1" placeholder="è¡Œ rows" style="flex:1; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" />
                <input id="custom-cols" type="number" min="1" placeholder="åˆ— cols" style="flex:1; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" />
            </div>
            <div style="font-size:12px; color:#a8b3c7; margin-top:6px;">æç¤ºï¼šè¡ŒÃ—åˆ—å»ºè®® â‰¤ 400ï¼Œä»¥å…é¡µé¢å¡é¡¿ã€‚</div>
        </div>
        <button id="btn-add-box" style="width:100%; padding:10px; border-radius:6px; border:none; background:var(--primary); color:white; cursor:pointer; font-weight:bold;">+ æ–°å¢å®¹å™¨</button>
    </div>
</div>

<div class="main">
    <div class="header">
        <div class="search-wrapper">
            <input type="text" id="global-search" class="search-bar" placeholder="ğŸ” å…¨å±€æœç´¢ç»†èƒå" >
            <div id="search-dropdown" class="search-dropdown"></div>
        </div>
        <div class="data-btns">
            <button class="btn-ghost" id="btn-export">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
            <button class="btn-ghost" id="btn-import">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <input type="file" id="import-file" style="display:none" >
        </div>
    </div>

    <div class="content">
        <div class="box-view">
            <button id="btn-toggle-settings" class="btn-ghost" style="position:absolute; top:12px; left:12px; display:none;" >âš™ï¸ å®¹å™¨è®¾ç½®</button>
            <div id="empty-tip" style="color:#999; margin-top: 50px;">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ–°å¢ä¸€ä¸ªå®¹å™¨</div>

            
<div id="box-settings" class="card settings-card" style="display:none;">
    <div class="settings-header">
        <div class="settings-title">
            <h3>ğŸ§· å®¹å™¨è®¾ç½®</h3>
            <div class="sub">ä»…å½±å“å½“å‰å®¹å™¨çš„æ˜¾ç¤ºæ–¹å¼</div>
        </div>
    </div>

    <div class="settings-divider"></div>

    <div class="setting-item">
        <label for="label-mode">æ ¼å­æ ‡å·æ˜¾ç¤º</label>
        <select id="label-mode" style="width:100%;">
            <option value="rc">è¡Œ-åˆ—ï¼ˆ1-1, 1-2...ï¼‰</option>
            <option value="a1">è¡Œå­—æ¯+åˆ—æ•°å­—ï¼ˆA1, B1...ï¼‰</option>
            <option value="linear">çº¿æ€§ç¼–å·ï¼ˆ1..Nï¼‰</option>
        </select>
        <div class="setting-hint">å°æŠ€å·§ï¼šæŒ‰ä½ <strong>Shift</strong> å•å‡»ä»»æ„æ ¼å­å¯ä¸ºè¯¥æ ¼è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆç•™ç©ºå¯å–æ¶ˆè¦†ç›–ï¼‰ã€‚</div>
    </div>

    <div class="settings-actions">
        <button class="btn-ghost" id="btn-clear-labels" title="æ¸…ç©ºå½“å‰å®¹å™¨æ‰€æœ‰è‡ªå®šä¹‰æ ‡ç­¾">æ¸…ç©ºè‡ªå®šä¹‰æ ‡ç­¾</button>
    </div>
</div>

<div id="grid" class="grid"></div>
        </div>

        <div class="panel">
            <div class="card">
                <h3>ğŸ“ æ ·æœ¬ç®¡ç†</h3>
                <div id="stats-area" class="inventory-stats">
                    <div style="font-size:12px;">é€‰å®šä½ç½®: <strong id="sel-count">0</strong></div>
                    <div style="margin-top:8px;">
                        å…¨åº“æ€»ä½™é‡: <span id="total-inventory" style="font-size:22px; font-weight:bold;">0</span> ç®¡
                    </div>
                </div>
                <label>ç»†èƒåç§° (Name)</label>
                <input type="text" id="cell-name"  placeholder="ä¾‹å¦‚: HEK293T">
                <label>ä»£æ•° (P)</label>
                <input type="text" id="cell-p">
                <label>å†»å­˜æ—¥æœŸ</label>
                <input type="date" id="cell-date">
                
                <button class="btn-save" id="btn-save-batch">ä¿å­˜å¹¶å–æ¶ˆé€‰æ‹©</button>
                <button id="btn-clear-batch" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer; font-size:12px;">æ¸…ç©ºæ‰€é€‰ä½ç½® (å‡ºåº“)</button>
            </div>

            <div class="card">
                <h3 style="color:var(--danger); display:flex; align-items:center; justify-content:space-between; gap:10px;"><span>âš ï¸ ä½åº“å­˜é¢„è­¦</span><span style="font-size:12px; font-weight:700; color:#111827; display:flex; align-items:center; gap:6px;"><span style="color:#6b7280; font-weight:600;">é˜ˆå€¼</span><input id="low-stock-threshold" type="number" min="1" max="999" style="width:64px; padding:6px 8px; border-radius:10px; border:1px solid rgba(0,0,0,0.12);"></span></h3>
                <div id="global-warning-list" style="max-height:180px; overflow-y:auto; font-size:13px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
(() => {
  'use strict';

  // =========================
  // Config / Constants
  // =========================
  const STORAGE_KEY = 'cell_storage_v1_db'; // keep for backward compatibility
  const DB_VERSION = 3;
  const MAX_CELLS = 400;
  const UNDO_LIMIT = 30;

  // =========================
  // DOM Cache
  // =========================
  const el = {};
  function cacheDom() {
    el.boxList = document.getElementById('box-list');
    el.newBoxSpecs = document.getElementById('new-box-specs');
    el.customSpecFields = document.getElementById('custom-spec-fields');
    el.customRows = document.getElementById('custom-rows');
    el.customCols = document.getElementById('custom-cols');
    el.btnAddBox = document.getElementById('btn-add-box');

    el.btnExport = document.getElementById('btn-export');
    el.btnImport = document.getElementById('btn-import');
    el.importFile = document.getElementById('import-file');

    el.btnToggleSettings = document.getElementById('btn-toggle-settings');
    el.boxSettings = document.getElementById('box-settings');
    el.labelMode = document.getElementById('label-mode');
    el.btnClearLabels = document.getElementById('btn-clear-labels');

    el.emptyTip = document.getElementById('empty-tip');
    el.grid = document.getElementById('grid');

    el.cellName = document.getElementById('cell-name');
    el.cellP = document.getElementById('cell-p');
    el.cellDate = document.getElementById('cell-date');
    el.selCount = document.getElementById('sel-count');
    el.btnSaveBatch = document.getElementById('btn-save-batch');
    el.btnClearBatch = document.getElementById('btn-clear-batch');

    el.totalInventory = document.getElementById('total-inventory');
    el.statsArea = document.getElementById('stats-area');

    el.globalSearch = document.getElementById('global-search');
    el.searchDropdown = document.getElementById('search-dropdown');
    el.warningList = document.getElementById('global-warning-list');
    el.lowStockThreshold = document.getElementById('low-stock-threshold');

    // New box modal
    el.newBoxModalOverlay = document.getElementById('newbox-modal-overlay');
    el.newBoxNameInput = document.getElementById('newbox-name-input');
    el.newBoxModalHint = document.getElementById('newbox-modal-hint');
    el.newBoxModalError = document.getElementById('newbox-modal-error');
    el.newBoxCancel = document.getElementById('newbox-cancel');
    el.newBoxConfirm = document.getElementById('newbox-confirm');

    // Label modal
    el.labelModalOverlay = document.getElementById('label-modal-overlay');
    el.labelModalHint = document.getElementById('label-modal-hint');
    el.labelModalError = document.getElementById('label-modal-error');
    el.labelInput = document.getElementById('label-input');
    el.labelCancel = document.getElementById('label-cancel');
    el.labelClear = document.getElementById('label-clear');
    el.labelConfirm = document.getElementById('label-confirm');

    // Rename box modal
    el.renameBoxModalOverlay = document.getElementById('renamebox-modal-overlay');
    el.renameBoxNameInput = document.getElementById('renamebox-name-input');
    el.renameBoxModalHint = document.getElementById('renamebox-modal-hint');
    el.renameBoxModalError = document.getElementById('renamebox-modal-error');
    el.renameBoxCancel = document.getElementById('renamebox-cancel');
    el.renameBoxConfirm = document.getElementById('renamebox-confirm');
  }

  // =========================
  // State
  // =========================
  const state = {
    db: null,
    currentBoxId: null,
    selectedPositions: new Set(),
    searchHighlightPos: null,
    searchHighlightTimer: null,
    undoStack: [],
    pendingNewBox: null,
    pendingLabelPos: null,
    pendingRenameBoxId: null,
    grid: {
      boxId: null,
      rows: 0,
      cols: 0,
      cellMap: new Map(),
    }
  };

  // =========================
  // Storage / Migration / Validation
  // =========================
  function defaultDB() {
    return { version: DB_VERSION, boxes: {}, config: { lowStockThreshold: 2 } };
  }

  function loadDB() {
    let db;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      db = raw ? JSON.parse(raw) : defaultDB();
    } catch (e) {
      console.warn('DB parse failed, reset.', e);
      db = defaultDB();
    }
    state.db = migrateDB(db);
    saveDB();
  }

  function saveDB() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.db));
  }

  function migrateDB(db) {
    if (!db || typeof db !== 'object') db = {};
    if (!db.boxes || typeof db.boxes !== 'object') db.boxes = {};
    if (!db.config || typeof db.config !== 'object') db.config = {};
    if (!Number.isInteger(db.version)) db.version = 1;
    if (db.version < 2) {
      // v1 -> v2: normalize schema, add missing fields, normalize labelMode
      Object.entries(db.boxes).forEach(([id, box]) => normalizeBoxInPlace(id, box, db.boxes));
      db.version = 2;
    }

    if (db.version < 3) {
      // v2 -> v3: add global config (low stock threshold)
      if (!db.config || typeof db.config !== 'object') db.config = {};
      if (!Number.isInteger(db.config.lowStockThreshold) || db.config.lowStockThreshold < 1) db.config.lowStockThreshold = 2;
      db.version = 3;
    }

    db.version = DB_VERSION;
    Object.entries(db.boxes).forEach(([id, box]) => normalizeBoxInPlace(id, box, db.boxes));
    return db;
  }

  function validateAndSanitizeImportedDB(data) {
    const errors = [];
    if (!data || typeof data !== 'object') errors.push('æ ¹å¯¹è±¡ä¸æ˜¯å¯¹è±¡ã€‚');
    if (!data.boxes || typeof data.boxes !== 'object') errors.push('ç¼ºå°‘ boxes æˆ– boxes ä¸æ˜¯å¯¹è±¡ã€‚');
    if (errors.length) return { ok: false, errors };

    const sanitized = defaultDB();
    sanitized.version = Number.isInteger(data.version) ? data.version : 1;

    for (const [id, box] of Object.entries(data.boxes)) {
      if (typeof id !== 'string' || !id.trim()) continue;
      if (!box || typeof box !== 'object') continue;

      const rows = Number.isInteger(box.rows) ? box.rows : 10;
      const cols = Number.isInteger(box.cols) ? box.cols : 10;
      if (rows < 1 || cols < 1 || rows * cols > 5000) continue;

      const b = createBoxSkeleton(typeof box.name === 'string' ? box.name : 'æœªå‘½åå®¹å™¨', rows, cols);
      b.labelMode = normalizeLabelMode(box.labelMode);

      // customLabels whitelist
      if (box.customLabels && typeof box.customLabels === 'object') {
        for (const [pos, lab] of Object.entries(box.customLabels)) {
          if (typeof lab !== 'string') continue;
          if (!isValidPos(pos, rows, cols)) continue;
          b.customLabels[pos] = lab;
        }
      }

      // vials whitelist
      if (box.vials && typeof box.vials === 'object') {
        for (const [pos, vial] of Object.entries(box.vials)) {
          if (!isValidPos(pos, rows, cols)) continue;
          if (!vial || typeof vial !== 'object') continue;
          b.vials[pos] = {
            name: typeof vial.name === 'string' ? vial.name : '',
            p: typeof vial.p === 'string' ? vial.p : '',
            date: typeof vial.date === 'string' ? vial.date : '',
            notes: typeof vial.notes === 'string' ? vial.notes : ''
          };
        }
      }

      sanitized.boxes[id] = b;
    }

    if (Object.keys(sanitized.boxes).length === 0) {
      return { ok: false, errors: ['å¯¼å…¥æ•°æ®ä¸­æ²¡æœ‰æœ‰æ•ˆçš„å®¹å™¨ï¼ˆboxes ä¸ºç©ºæˆ–å…¨éƒ¨æ— æ•ˆï¼‰ã€‚'] };
    }

    return { ok: true, errors: [], db: migrateDB(sanitized) };
  }

  function normalizeBoxInPlace(id, box, boxesObj) {
    if (!box || typeof box !== 'object') {
      boxesObj[id] = createBoxSkeleton('æœªå‘½åå®¹å™¨', 10, 10);
      box = boxesObj[id];
    }
    if (typeof box.name !== 'string') box.name = 'æœªå‘½åå®¹å™¨';
    if (!Number.isInteger(box.rows) || box.rows < 1) box.rows = 10;
    if (!Number.isInteger(box.cols) || box.cols < 1) box.cols = 10;
    if (!box.vials || typeof box.vials !== 'object') box.vials = {};
    if (!box.customLabels || typeof box.customLabels !== 'object') box.customLabels = {};
    box.labelMode = normalizeLabelMode(box.labelMode);

    // prune vials/customLabels out of range and normalize fields
    Object.keys(box.vials).forEach((pos) => {
      if (!isValidPos(pos, box.rows, box.cols)) { delete box.vials[pos]; return; }
      const vial = box.vials[pos];
      if (!vial || typeof vial !== 'object') { delete box.vials[pos]; return; }
      vial.name = typeof vial.name === 'string' ? vial.name : '';
      vial.p = typeof vial.p === 'string' ? vial.p : '';
      vial.date = typeof vial.date === 'string' ? vial.date : '';
      vial.notes = typeof vial.notes === 'string' ? vial.notes : '';
    });
    Object.keys(box.customLabels).forEach((pos) => {
      if (!isValidPos(pos, box.rows, box.cols)) delete box.customLabels[pos];
      else if (typeof box.customLabels[pos] !== 'string') delete box.customLabels[pos];
    });
  }

  // =========================
  // Helpers
  // =========================

  // =========================
  // Modal: New Box Name
  // =========================
  function openNewBoxModal(rows, cols) {
    const overlay = el.newBoxModalOverlay;
    if (!overlay) return;

    const defaultName = `å®¹å™¨ ${Object.keys(state.db.boxes).length + 1}`;
    state.pendingNewBox = { rows, cols };

    el.newBoxModalError.style.display = 'none';
    el.newBoxModalError.textContent = '';
    el.newBoxNameInput.value = defaultName;
    el.newBoxModalHint.textContent = `å°†åˆ›å»ºè§„æ ¼ï¼š${rows} Ã— ${cols}`;

    overlay.style.display = 'flex';
    // focus + select for quick overwrite
    setTimeout(() => {
      el.newBoxNameInput.focus();
      el.newBoxNameInput.select();
    }, 0);
  }

  function closeNewBoxModal() {
    if (!el.newBoxModalOverlay) return;
    el.newBoxModalOverlay.style.display = 'none';
    state.pendingNewBox = null;
  }

  function ensureUniqueBoxName(name) {
    const existing = new Set(Object.values(state.db.boxes).map(b => (b.name || '').trim()));
    if (!existing.has(name)) return name;

    let i = 2;
    while (existing.has(`${name} (${i})`)) i++;
    return `${name} (${i})`;
  }

  function confirmCreateNewBoxFromModal() {
    if (!state.pendingNewBox) return;

    const raw = (el.newBoxNameInput.value || '').trim();
    const base = raw || `å®¹å™¨ ${Object.keys(state.db.boxes).length + 1}`;
    const name = ensureUniqueBoxName(base);

    const { rows, cols } = state.pendingNewBox;

    const id = `box_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    state.db.boxes[id] = createBoxSkeleton(name, rows, cols);
    saveDB();

    state.currentBoxId = id;
    state.selectedPositions.clear();
    state.searchHighlightPos = null;
    el.labelMode.value = state.db.boxes[id].labelMode;

    closeNewBoxModal();
    renderAll();
  }


  // =========================
  // Modal: Custom Label
  // =========================
  function openLabelModal(pos) {
    const box = state.db.boxes[state.currentBoxId];
    if (!box || !el.labelModalOverlay) return;

    state.pendingLabelPos = pos;
    const current = (box.customLabels && box.customLabels[pos]) ? box.customLabels[pos] : '';

    el.labelModalError.style.display = 'none';
    el.labelModalError.textContent = '';
    el.labelInput.value = current;

    const shown = `${posToLabel(box, pos)}ï¼ˆ${pos}ï¼‰`;
    el.labelModalHint.textContent = `ä½ç½®ï¼š${shown}`;

    el.labelModalOverlay.style.display = 'flex';
    setTimeout(() => {
      el.labelInput.focus();
      el.labelInput.select();
    }, 0);
  }

  function closeLabelModal() {
    if (!el.labelModalOverlay) return;
    el.labelModalOverlay.style.display = 'none';
    state.pendingLabelPos = null;
  }

  function saveLabelFromModal(mode) {
    const box = state.db.boxes[state.currentBoxId];
    const pos = state.pendingLabelPos;
    if (!box || !pos) return;

    const prev = { ...(box.customLabels || {}) };
    pushUndo({ type: 'labels', boxId: state.currentBoxId, prev });

    if (mode === 'clear') {
      if (box.customLabels) delete box.customLabels[pos];
    } else {
      const v = (el.labelInput.value || '').trim();
      if (!v) {
        if (box.customLabels) delete box.customLabels[pos];
      } else {
        if (!box.customLabels || typeof box.customLabels !== 'object') box.customLabels = {};
        box.customLabels[pos] = v;
      }
    }

    saveDB();
    paintCell(pos);
    closeLabelModal();
  }


  // =========================
  // Modal: Rename Box
  // =========================
  function openRenameBoxModal(boxId) {
    const box = state.db.boxes[boxId];
    if (!box || !el.renameBoxModalOverlay) return;

    state.pendingRenameBoxId = boxId;

    el.renameBoxModalError.style.display = 'none';
    el.renameBoxModalError.textContent = '';
    el.renameBoxNameInput.value = (box.name || '').trim() || `å®¹å™¨`;
    el.renameBoxModalHint.textContent = `è§„æ ¼ï¼š${box.rows} Ã— ${box.cols}`;

    el.renameBoxModalOverlay.style.display = 'flex';
    setTimeout(() => {
      el.renameBoxNameInput.focus();
      el.renameBoxNameInput.select();
    }, 0);
  }

  function closeRenameBoxModal() {
    if (!el.renameBoxModalOverlay) return;
    el.renameBoxModalOverlay.style.display = 'none';
    state.pendingRenameBoxId = null;
  }

  function confirmRenameBoxFromModal() {
    const boxId = state.pendingRenameBoxId;
    const box = state.db.boxes[boxId];
    if (!box) return;

    const raw = (el.renameBoxNameInput.value || '').trim();
    const next = raw || box.name || `å®¹å™¨`;

    // avoid empty; allow duplicate names (consistent with previous behavior)
    box.name = next;
    saveDB();
    renderBoxList();
    closeRenameBoxModal();
  }



  const clampInt = (n, min, max) => Math.max(min, Math.min(max, n));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));

  function normalizeLabelMode(mode) {
    const m = String(mode || '').toLowerCase().trim();
    if (m === 'a1' || m.includes('a1')) return 'a1';
    if (m === 'linear' || m.includes('linear')) return 'linear';
    if (m === 'rc' || m === 'r-c' || m.includes('row') || m.includes('col')) return 'rc';
    return 'rc';
  }

  function createBoxSkeleton(name, rows, cols) {
    return { name, rows, cols, vials: {}, labelMode: 'rc', customLabels: {} };
  }

  function isValidPos(pos, rows, cols) {
    if (typeof pos !== 'string') return false;
    const m = pos.match(/^(\d+)-(\d+)$/);
    if (!m) return false;
    const r = parseInt(m[1], 10), c = parseInt(m[2], 10);
    if (rows && cols) return r >= 1 && r <= rows && c >= 1 && c <= cols;
    return r >= 1 && c >= 1;
  }

  function rowNumberToLetters(n) {
    let s = '';
    let x = n;
    while (x > 0) {
      const r = (x - 1) % 26;
      s = String.fromCharCode(65 + r) + s;
      x = Math.floor((x - 1) / 26);
    }
    return s;
  }

  function posToLabel(box, pos) {
    const [rStr, cStr] = pos.split('-');
    const r = parseInt(rStr, 10);
    const c = parseInt(cStr, 10);

    if (box.customLabels && box.customLabels[pos]) return box.customLabels[pos];

    if (box.labelMode === 'a1') return `${rowNumberToLetters(r)}${c}`;
    if (box.labelMode === 'linear') return String((r - 1) * box.cols + c);
    return `${r}-${c}`;
  }

  function stringToHslColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
      hash |= 0;
    }
    const h = Math.abs(hash) % 360;
    return `hsl(${h}, 60%, 88%)`;
  }

  function downloadText(filename, text) {
    const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function pushUndo(entry) {
    state.undoStack.push(entry);
    if (state.undoStack.length > UNDO_LIMIT) state.undoStack.shift();
  }

  function applyUndo() {
    const last = state.undoStack.pop();
    if (!last) return;
    const box = state.db.boxes[last.boxId];
    if (!box) return;

    if (last.type === 'move') {
      if (last.toVial) box.vials[last.toPos] = last.toVial; else delete box.vials[last.toPos];
      if (last.fromVial) box.vials[last.fromPos] = last.fromVial; else delete box.vials[last.fromPos];
      saveDB();
      paintCell(last.fromPos);
      paintCell(last.toPos);
    } else if (last.type === 'batch') {
      last.prev.forEach(({pos, vial}) => {
        if (vial) box.vials[pos] = vial;
        else delete box.vials[pos];
        paintCell(pos);
      });
      saveDB();
    } else if (last.type === 'labels') {
      box.customLabels = last.prev || {};
      saveDB();
      refreshAllCells(); // label affects all cells
    }

    updateLiveStats();
    updateWarningBoard();
  }

  // =========================
  // Rendering (Incremental Grid)
  // =========================
  function renderAll() {
    renderBoxList();
    ensureGridBuilt();
    refreshAllCells();
    updatePanel();
    updateLiveStats();
    updateWarningBoard();
  }

  function renderBoxList() {
    const ids = Object.keys(state.db.boxes);
    if (!ids.length) {
      el.boxList.innerHTML = '<div style="opacity:.6;font-size:12px;line-height:1.6;">æš‚æ— å®¹å™¨ï¼Œè¯·å…ˆæ·»åŠ ã€‚</div>';
      el.emptyTip.style.display = 'block';
      el.btnToggleSettings.style.display = 'none';
      el.grid.innerHTML = '';
      return;
    }
    el.emptyTip.style.display = 'none';
    el.btnToggleSettings.style.display = 'inline-flex';

    el.boxList.innerHTML = ids.map(id => {
      const box = state.db.boxes[id];
      const active = id === state.currentBoxId ? 'active' : '';
      const tag = `${box.rows}Ã—${box.cols}`;
      return `
        <div class="box-item ${active}" data-boxid="${escapeHtml(id)}">
          <div class="box-info" title="${escapeHtml(box.name)}">${escapeHtml(box.name)} <span class="box-tag">${escapeHtml(tag)}</span></div>
          <div style="display:flex;align-items:center;gap:6px;">
            <div class="btn-rename-box" data-action="rename" data-boxid="${escapeHtml(id)}" title="é‡å‘½å">âœ</div>
            <div class="btn-delete-box" data-action="delete" data-boxid="${escapeHtml(id)}" title="åˆ é™¤">Ã—</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function ensureGridBuilt() {
    const box = state.db.boxes[state.currentBoxId];
    if (!box) {
      el.grid.innerHTML = '';
      state.grid.boxId = null;
      state.grid.cellMap.clear();
      return;
    }

    const needsRebuild =
      state.grid.boxId !== state.currentBoxId ||
      state.grid.rows !== box.rows ||
      state.grid.cols !== box.cols ||
      state.grid.cellMap.size !== box.rows * box.cols;

    if (!needsRebuild) {
      el.grid.style.gridTemplateColumns = `repeat(${box.cols}, 1fr)`;
      el.grid.style.gridTemplateRows = `repeat(${box.rows}, 1fr)`;
      return;
    }

    state.grid.boxId = state.currentBoxId;
    state.grid.rows = box.rows;
    state.grid.cols = box.cols;
    state.grid.cellMap.clear();

    el.grid.style.gridTemplateColumns = `repeat(${box.cols}, 1fr)`;
    el.grid.style.gridTemplateRows = `repeat(${box.rows}, 1fr)`;

    const frag = document.createDocumentFragment();
    for (let r = 1; r <= box.rows; r++) {
      for (let c = 1; c <= box.cols; c++) {
        const pos = `${r}-${c}`;
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.pos = pos;
        frag.appendChild(cell);
        state.grid.cellMap.set(pos, cell);
      }
    }
    el.grid.innerHTML = '';
    el.grid.appendChild(frag);
  }

  function refreshAllCells() {
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    for (let r = 1; r <= box.rows; r++) {
      for (let c = 1; c <= box.cols; c++) {
        paintCell(`${r}-${c}`);
      }
    }
  }

  function paintCell(pos) {
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    const cell = state.grid.cellMap.get(pos);
    if (!cell) return;

    const label = posToLabel(box, pos);
    const vial = box.vials[pos];

    cell.dataset.label = label;

    cell.classList.toggle('occupied', !!vial);
    cell.classList.toggle('selected', state.selectedPositions.has(pos));
    cell.classList.toggle('highlight-target', state.searchHighlightPos === pos);

    if (vial) cell.setAttribute('draggable', 'true');
    else cell.removeAttribute('draggable');

    if (vial) {
      const name = (vial.name || '').trim();
      const p = (vial.p || '').trim();
      const date = (vial.date || '').trim();
      cell.style.background = stringToHslColor(name);
      cell.title = `${label}\n${name}  ${p}  ${date}`.trim();
      cell.innerHTML = `
        <span class="cell-label">${escapeHtml(label)}</span>
        <span class="cell-name">${escapeHtml(name || 'â€”')}</span>
        <span class="cell-meta">${escapeHtml(p || '')}</span>
      `;
    } else {
      cell.style.background = '';
      cell.title = label;
      cell.innerHTML = `<span class="cell-label">${escapeHtml(label)}</span>`;
    }
  }

  // =========================
  // Panel / Stats / Warning
  // =========================
  function updatePanel() {
    const n = state.selectedPositions.size;
    el.selCount.textContent = String(n);
    el.btnSaveBatch.disabled = n === 0 || !state.currentBoxId;
    el.btnClearBatch.disabled = n === 0 || !state.currentBoxId;
  }

  function updateLiveStats() {
    const name = el.cellName.value.trim();
    if (!name) {
      el.totalInventory.textContent = '0';
      el.statsArea.innerHTML = `<div style="color:#666; font-size:12px;">è¾“å…¥ç»†èƒååæ˜¾ç¤ºç»Ÿè®¡</div>`;
      return;
    }

    const key = name.toLowerCase();
    const matches = [];
    for (const [boxId, box] of Object.entries(state.db.boxes)) {
      for (const [pos, vial] of Object.entries(box.vials || {})) {
        if ((vial.name || '').toLowerCase() === key) {
          matches.push({ boxId, boxName: box.name, pos, label: posToLabel(box, pos), p: vial.p || '', date: vial.date || '' });
        }
      }
    }

    el.totalInventory.textContent = String(matches.length);
    if (!matches.length) {
      el.statsArea.innerHTML = `<div style="color:#666; font-size:12px;">æœªæ‰¾åˆ°è¯¥ç»†èƒçš„å†»å­˜è®°å½•</div>`;
      return;
    }

    const byP = new Map();
    for (const m of matches) {
      const p = (m.p || '').trim() || 'æœªå¡«å†™';
      if (!byP.has(p)) byP.set(p, []);
      byP.get(p).push(m);
    }

    const rows = [...byP.entries()]
      .sort((a,b) => a[0].localeCompare(b[0], 'zh-Hans-CN'))
      .map(([p, arr]) => {
        const chips = arr.slice(0, 8).map(x => `<span class="chip" title="${escapeHtml(x.boxName)} @ ${escapeHtml(x.label)}">${escapeHtml(x.label)}</span>`).join(' Â· ');
        const more = arr.length > 8 ? `<span class="muted">+${arr.length - 8}...</span>` : '';
        return `
          <div class="stat-row">
            <div class="stat-left"><strong>${escapeHtml(p)}</strong><div class="muted">${arr.length} ç®¡</div></div>
            <div class="stat-right">${chips} ${more}</div>
          </div>
        `;
      }).join('');

    el.statsArea.innerHTML = rows;
  }

  function updateWarningBoard() {
    const counts = new Map();
    const nameMap = new Map();
    for (const box of Object.values(state.db.boxes)) {
      for (const vial of Object.values(box.vials || {})) {
        const name = (vial.name || '').trim();
        if (!name) continue;
        const k = name.toLowerCase();
        if(!nameMap.has(k)) nameMap.set(k, name);
        counts.set(k, (counts.get(k) || 0) + 1);
      }
    }
    const threshold = parseInt(state.db?.config?.lowStockThreshold || (el.lowStockThreshold ? el.lowStockThreshold.value : 2) || 2, 10);
    const th = (Number.isFinite(threshold) && threshold > 0) ? threshold : 2;
    const warnings = [...counts.entries()].filter(([, n]) => n <= th).sort((a,b) => a[1]-b[1]);
    if (!warnings.length) {
      el.warningList.innerHTML = `<div class="muted">æš‚æ— ä½åº“å­˜é¢„è­¦</div>`;
      return;
    }
    el.warningList.innerHTML = warnings.slice(0, 20).map(([k, n]) => {
      const displayName = nameMap.get(k) || k;
      return `
        <div class="warn-item">
          <div class="warn-left">
            <div class="warn-name">${escapeHtml(displayName)}</div>
            <div class="warn-sub">ä½™é‡é¢„è­¦</div>
          </div>
          <div class="warn-count">${n} ç®¡</div>
        </div>
      `;
    }).join('');
  }

  // =========================
  // Actions: Select / Batch / Drag / Settings
  // =========================
  function toggleSelect(pos) {
    // any manual interaction cancels search highlight
    clearSearchHighlight();
    if (!state.currentBoxId) return;
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    if (!isValidPos(pos, box.rows, box.cols)) return;

    if (state.selectedPositions.has(pos)) state.selectedPositions.delete(pos);
    else state.selectedPositions.add(pos);

    paintCell(pos);
    updatePanel();
  }

  function batchSave() {
    if (!state.currentBoxId) return;
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    const positions = [...state.selectedPositions];
    if (!positions.length) return;

    const name = el.cellName.value.trim();
    const p = el.cellP.value.trim();
    const date = el.cellDate.value.trim();

    const prev = positions.map(pos => ({ pos, vial: box.vials[pos] ? { ...box.vials[pos] } : null }));
    pushUndo({ type: 'batch', boxId: state.currentBoxId, prev });

    positions.forEach(pos => {
      box.vials[pos] = { name, p, date, notes: box.vials[pos]?.notes || '' };
      paintCell(pos);
    });

    saveDB();
    state.selectedPositions.clear();
    // remove selection class from previously selected cells efficiently
    prev.forEach(({pos}) => paintCell(pos));

    updatePanel();
    updateLiveStats();
    updateWarningBoard();
  }

  function batchClear() {
    if (!state.currentBoxId) return;
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    const positions = [...state.selectedPositions];
    if (!positions.length) return;

    const prev = positions.map(pos => ({ pos, vial: box.vials[pos] ? { ...box.vials[pos] } : null }));
    pushUndo({ type: 'batch', boxId: state.currentBoxId, prev });

    positions.forEach(pos => {
      delete box.vials[pos];
      paintCell(pos);
    });

    saveDB();
    state.selectedPositions.clear();
    prev.forEach(({pos}) => paintCell(pos));

    updatePanel();
    updateLiveStats();
    updateWarningBoard();
  }

  function moveVial(fromPos, toPos) {
    if (!state.currentBoxId) return;
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    if (!box.vials[fromPos]) return;
    if (box.vials[toPos]) return;

    const fromVial = { ...box.vials[fromPos] };
    const toVial = box.vials[toPos] ? { ...box.vials[toPos] } : null;

    pushUndo({ type: 'move', boxId: state.currentBoxId, fromPos, toPos, fromVial, toVial });

    box.vials[toPos] = fromVial;
    delete box.vials[fromPos];
    saveDB();
    paintCell(fromPos);
    paintCell(toPos);

    updateLiveStats();
    updateWarningBoard();
  }

  function applyLabelMode() {
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    box.labelMode = normalizeLabelMode(el.labelMode.value);
    saveDB();
    refreshAllCells(); // labels change, but structure same
  }

  function clearCustomLabels() {
    const box = state.db.boxes[state.currentBoxId];
    if (!box) return;
    const prev = { ...box.customLabels };
    pushUndo({ type: 'labels', boxId: state.currentBoxId, prev });
    box.customLabels = {};
    saveDB();
    refreshAllCells();
  }

  function setCustomLabelForPos(pos) {
    // Use modal instead of browser prompt for a better UX
    openLabelModal(pos);
  }

  
  function clearSearchHighlight() {
    if (state.searchHighlightTimer) {
      clearTimeout(state.searchHighlightTimer);
      state.searchHighlightTimer = null;
    }
    if (state.searchHighlightPos) {
      const prev = state.searchHighlightPos;
      state.searchHighlightPos = null;
      paintCell(prev);
    }
  }


// =========================
  // Search
  // =========================
  function searchAll(keyword) {
    const kw = keyword.trim().toLowerCase();
    if (!kw) return [];
    const matches = [];
    for (const [boxId, box] of Object.entries(state.db.boxes)) {
      for (const [pos, vial] of Object.entries(box.vials || {})) {
        const name = (vial.name || '').trim();
        if (!name) continue;
        if (name.toLowerCase().includes(kw)) {
          matches.push({
            boxId,
            boxName: box.name,
            pos,
            label: posToLabel(box, pos),
            name,
            p: (vial.p || '').trim(),
            date: (vial.date || '').trim()
          });
        }
      }
    }
    return matches.slice(0, 50);
  }

  function renderSearchDropdown(matches) {
    if (!matches.length) {
      el.searchDropdown.style.display = 'none';
      el.searchDropdown.innerHTML = '';
      return;
    }
    el.searchDropdown.style.display = 'block';
    el.searchDropdown.innerHTML = matches.map((m, idx) => {
      return `
        <div class="search-item" data-action="jump-search" data-idx="${idx}">
          <div class="search-title">${escapeHtml(m.name)} <span class="search-tag">[${escapeHtml(m.label)}]</span></div>
          <div class="search-sub">${escapeHtml(m.boxName)} Â· ${escapeHtml(m.p)} ${escapeHtml(m.date)}</div>
        </div>
      `;
    }).join('');
    el.searchDropdown._matches = matches;
  }

  function jumpToSearchIndex(idx) {
    const matches = el.searchDropdown._matches || [];
    const m = matches[idx];
    if (!m) return;

    if (state.currentBoxId !== m.boxId) {
      state.currentBoxId = m.boxId;
      state.selectedPositions.clear();
      ensureGridBuilt();
      renderBoxList();
      // ensure label mode UI matches
      el.labelMode.value = state.db.boxes[state.currentBoxId].labelMode;
    }

        // highlight the target briefly (auto stop blinking)
    const prev = state.searchHighlightPos;
    if (state.searchHighlightTimer) { clearTimeout(state.searchHighlightTimer); state.searchHighlightTimer = null; }
    state.searchHighlightPos = m.pos;
    if (prev) paintCell(prev);
    paintCell(m.pos);
    state.searchHighlightTimer = setTimeout(() => {
      clearSearchHighlight();
    }, 2000);

    const cell = state.grid.cellMap.get(m.pos);
    if (cell) cell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

    updatePanel();
    updateLiveStats();
    updateWarningBoard();
    // auto clear search box after jump
    el.globalSearch.value = '';
    el.searchDropdown.style.display = 'none';
  }

  // =========================
  // Import / Export
  // =========================
  function exportDB() {
    const stamp = new Date().toISOString().replace(/[:.]/g, '-');
    downloadText(`cell_freeze_backup_${stamp}.json`, JSON.stringify(state.db, null, 2));
  }

  function importDBFromFile(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result || ''));
        const res = validateAndSanitizeImportedDB(data);
        if (!res.ok) {
          alert('å¯¼å…¥å¤±è´¥ï¼š\n' + res.errors.map(e => `- ${e}`).join('\n'));
          return;
        }
        state.db = res.db;
        saveDB();
        state.currentBoxId = Object.keys(state.db.boxes)[0] || null;
        state.selectedPositions.clear();
        state.searchHighlightPos = null;
        state.undoStack = [];
        // sync label mode UI
        if (state.currentBoxId) el.labelMode.value = state.db.boxes[state.currentBoxId].labelMode;
    // init low stock threshold
    if (el.lowStockThreshold) {
      const t = parseInt(state.db?.config?.lowStockThreshold || 2, 10);
      el.lowStockThreshold.value = String(Number.isFinite(t) && t > 0 ? t : 2);
    }
        renderAll();
        alert('å¯¼å…¥æˆåŠŸã€‚');
      } catch (e) {
        alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£æ JSONã€‚');
      }
    };
    reader.readAsText(file, 'utf-8');
  }

  // =========================
  // Box CRUD
  // =========================
  function addNewBox() {
    const spec = el.newBoxSpecs.value;
    let rows = 10, cols = 10;

    if (spec === 'custom') {
      rows = clampInt(parseInt(el.customRows.value, 10) || 1, 1, 100);
      cols = clampInt(parseInt(el.customCols.value, 10) || 1, 1, 100);
    } else {
      const s = String(spec).trim();
      // æ”¯æŒï¼š9,9  / 9x9 / 9Ã—9 / 9X9
      const m = s.match(/^(\d+)\s*[,xXÃ—]\s*(\d+)$/);
      if (m) {
        rows = parseInt(m[1], 10);
        cols = parseInt(m[2], 10);
      }
    }

    if (rows * cols > MAX_CELLS) {
      alert(`è‡ªå®šä¹‰è§„æ ¼è¿‡å¤§ï¼ˆ${rows}Ã—${cols}=${rows * cols}ï¼‰ï¼Œè¯·æ§åˆ¶åœ¨ ${MAX_CELLS} æ ¼ä»¥å†…ã€‚`);
      return;
    }

    // Open elegant modal to name the new box
    openNewBoxModal(rows, cols);
  }

  function renameBox(boxId) {
    // Use modal instead of browser prompt
    openRenameBoxModal(boxId);
  }

  function deleteBox(boxId) {
    if (!state.db.boxes[boxId]) return;
    if (!confirm('ç¡®å®šåˆ é™¤è¯¥å®¹å™¨ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
    delete state.db.boxes[boxId];
    saveDB();
    const ids = Object.keys(state.db.boxes);
    state.currentBoxId = ids[0] || null;
    state.selectedPositions.clear();
    state.searchHighlightPos = null;
    if (state.currentBoxId) el.labelMode.value = state.db.boxes[state.currentBoxId].labelMode;
    renderAll();
  }

  function switchBox(boxId) {
    if (!state.db.boxes[boxId]) return;
    state.currentBoxId = boxId;
    state.selectedPositions.clear();
    clearSearchHighlight();
    el.labelMode.value = state.db.boxes[boxId].labelMode;
    renderAll();
  }

  // =========================
  // Events
  // =========================
  function bindEvents() {
    // Sidebar
    el.newBoxSpecs.addEventListener('change', toggleCustomSpecFields);
    el.btnAddBox.addEventListener('click', addNewBox);

    // Low stock threshold
    if (el.lowStockThreshold) {
      el.lowStockThreshold.addEventListener('input', () => {
        const v = parseInt(el.lowStockThreshold.value || '2', 10);
        const t = Number.isFinite(v) ? Math.max(1, Math.min(999, v)) : 2;
        el.lowStockThreshold.value = String(t);
        if (!state.db.config || typeof state.db.config !== 'object') state.db.config = {};
        state.db.config.lowStockThreshold = t;
        saveDB();
        updateWarningBoard();
      });
    }


    // New box modal events
    el.newBoxCancel.addEventListener('click', closeNewBoxModal);
    el.newBoxConfirm.addEventListener('click', confirmCreateNewBoxFromModal);

    // Click outside to close
    el.newBoxModalOverlay.addEventListener('click', (e) => {
      if (e.target === el.newBoxModalOverlay) closeNewBoxModal();
    });

    // Enter to confirm / Esc to cancel
    el.newBoxNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        confirmCreateNewBoxFromModal();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        closeNewBoxModal();
      }
    });


    // Box list delegation
    el.boxList.addEventListener('click', (e) => {
      const actionEl = e.target.closest('[data-action]');
      const itemEl = e.target.closest('.box-item');
      const boxId = actionEl?.dataset.boxid || itemEl?.dataset.boxid;
      if (!boxId) return;

      const action = actionEl?.dataset.action;
      if (action === 'delete') return deleteBox(boxId);
      if (action === 'rename') return renameBox(boxId);
      return switchBox(boxId);
    });



    // Label modal events
    el.labelCancel.addEventListener('click', closeLabelModal);
    el.labelConfirm.addEventListener('click', () => saveLabelFromModal('save'));
    el.labelClear.addEventListener('click', () => saveLabelFromModal('clear'));

    // Click outside to close
    el.labelModalOverlay.addEventListener('click', (e) => {
      if (e.target === el.labelModalOverlay) closeLabelModal();
    });

    // Enter to save / Esc to cancel
    el.labelInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveLabelFromModal('save');
      } else if (e.key === 'Escape') {
        e.preventDefault();
        closeLabelModal();
      }
    });


    // Toggle settings panel
    el.btnToggleSettings.addEventListener('click', () => {
      const isOpen = el.boxSettings.style.display !== 'none';
      el.boxSettings.style.display = isOpen ? 'none' : 'block';
    });

    el.labelMode.addEventListener('change', applyLabelMode);
    el.btnClearLabels.addEventListener('click', clearCustomLabels);

    // Grid delegation: click select / shift-click label
    el.grid.addEventListener('click', (e) => {
      const cell = e.target.closest('.cell');
      if (!cell) return;
      const pos = cell.dataset.pos;
      if (e.shiftKey) return setCustomLabelForPos(pos);
      toggleSelect(pos);
    });



    // Rename box modal events
    el.renameBoxCancel.addEventListener('click', closeRenameBoxModal);
    el.renameBoxConfirm.addEventListener('click', confirmRenameBoxFromModal);

    el.renameBoxModalOverlay.addEventListener('click', (e) => {
      if (e.target === el.renameBoxModalOverlay) closeRenameBoxModal();
    });

    el.renameBoxNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        confirmRenameBoxFromModal();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        closeRenameBoxModal();
      }
    });


    // Drag & drop delegation
    el.grid.addEventListener('dragstart', (e) => {
      const cell = e.target.closest('.cell');
      if (!cell) return;
      const pos = cell.dataset.pos;
      const box = state.db.boxes[state.currentBoxId];
      if (!box || !box.vials[pos]) return;
      e.dataTransfer.setData('text/plain', pos);
      e.dataTransfer.effectAllowed = 'move';
      cell.classList.add('dragging');
    });

    el.grid.addEventListener('dragend', (e) => {
      const cell = e.target.closest('.cell');
      if (cell) cell.classList.remove('dragging');
    });

    el.grid.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    });

    el.grid.addEventListener('drop', (e) => {
      e.preventDefault();
      const toCell = e.target.closest('.cell');
      if (!toCell) return;
      const fromPos = e.dataTransfer.getData('text/plain');
      const toPos = toCell.dataset.pos;
      if (!fromPos || !toPos || fromPos === toPos) return;
      moveVial(fromPos, toPos);
    });

    // Batch operations
    el.btnSaveBatch.addEventListener('click', batchSave);
    el.btnClearBatch.addEventListener('click', batchClear);

    // Stats react
    el.cellName.addEventListener('input', () => updateLiveStats());

    // Search
    el.globalSearch.addEventListener('input', () => {
      const matches = searchAll(el.globalSearch.value);
      renderSearchDropdown(matches);
    });


    el.globalSearch.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        el.globalSearch.value = '';
        renderSearchDropdown([]);
        clearSearchHighlight();
      }
    });

    document.addEventListener('click', (e) => {
      if (!el.searchDropdown.contains(e.target) && e.target !== el.globalSearch) {
        // auto clear search when clicking elsewhere
        el.searchDropdown.style.display = 'none';
        if (el.globalSearch.value.trim()) el.globalSearch.value = '';
      }
    });

    el.searchDropdown.addEventListener('click', (e) => {
      const item = e.target.closest('[data-action="jump-search"]');
      if (!item) return;
      jumpToSearchIndex(parseInt(item.dataset.idx, 10));
    });

    // Export / Import
    el.btnExport.addEventListener('click', exportDB);
    el.btnImport.addEventListener('click', () => el.importFile.click());
    el.importFile.addEventListener('change', () => {
      const file = el.importFile.files && el.importFile.files[0];
      if (!file) return;
      importDBFromFile(file);
      el.importFile.value = '';
    });

    // Undo hotkey
    document.addEventListener('keydown', (e) => {
      const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (mod && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        applyUndo();
      }
    });
  }

  function toggleCustomSpecFields() {
    const isCustom = el.newBoxSpecs.value === 'custom';
    el.customSpecFields.style.display = isCustom ? 'block' : 'none';
  }

  // =========================
  // Init
  // =========================
  function init() {
    cacheDom();
    loadDB();

    const ids = Object.keys(state.db.boxes);
    state.currentBoxId = ids.length ? ids[0] : null;
    if (state.currentBoxId) el.labelMode.value = state.db.boxes[state.currentBoxId].labelMode;

    bindEvents();
    toggleCustomSpecFields();
    renderAll();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

<!-- ========= æ–°å»ºå®¹å™¨ï¼šå‘½åæ¨¡æ€æ¡† ========= -->
<div id="newbox-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="newbox-modal-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">ğŸ“¦</div>
      <div>
        <div id="newbox-modal-title" class="modal-title">æ–°å»ºå®¹å™¨</div>
        <div id="newbox-modal-sub" class="modal-sub">ä¸ºæ–°å®¹å™¨è®¾ç½®åç§°ã€‚è§„æ ¼å°†æŒ‰ä½ åœ¨å·¦ä¾§é€‰æ‹©çš„è¡ŒÃ—åˆ—åˆ›å»ºã€‚</div>
      </div>
    </div>
    <div class="modal-body">
      <label for="newbox-name-input">å®¹å™¨åç§°</label>
      <input id="newbox-name-input" type="text" placeholder="ä¾‹å¦‚ï¼šHEK293T-1å·ç›’" autocomplete="off">
      <div id="newbox-modal-hint" class="modal-hint"></div>
      <div id="newbox-modal-error" class="modal-error"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal" id="newbox-cancel">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" id="newbox-confirm">åˆ›å»º</button>
    </div>
  </div>
</div>


<!-- ========= è‡ªå®šä¹‰æ ‡ç­¾ï¼šæ¨¡æ€æ¡† ========= -->
<div id="label-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="label-modal-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">ğŸ·ï¸</div>
      <div>
        <div id="label-modal-title" class="modal-title">è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾</div>
        <div id="label-modal-sub" class="modal-sub">ä¸ºè¯¥ä½ç½®è®¾ç½®ä¸€ä¸ªæ›´ç›´è§‚çš„æ ‡ç­¾ï¼ˆç•™ç©ºå¯æ¸…é™¤ï¼‰ã€‚</div>
      </div>
    </div>
    <div class="modal-body">
      <div id="label-modal-hint" class="modal-hint"></div>
      <label for="label-input">æ ‡ç­¾å†…å®¹</label>
      <input id="label-input" type="text" placeholder="ä¾‹å¦‚ï¼šæ¯ç®¡ / å¯¹ç…§ç»„ / æ‰¹æ¬¡A" autocomplete="off">
      <div id="label-modal-error" class="modal-error"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal" id="label-cancel">å–æ¶ˆ</button>
      <button class="btn-modal" id="label-clear">æ¸…é™¤</button>
      <button class="btn-modal btn-modal-primary" id="label-confirm">ä¿å­˜</button>
    </div>
  </div>
</div>


<!-- ========= é‡å‘½åå®¹å™¨ï¼šæ¨¡æ€æ¡† ========= -->
<div id="renamebox-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="renamebox-modal-title">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">âœï¸</div>
      <div>
        <div id="renamebox-modal-title" class="modal-title">é‡å‘½åå®¹å™¨</div>
        <div id="renamebox-modal-sub" class="modal-sub">ä¿®æ”¹å®¹å™¨åç§°ï¼Œä¸å½±å“å®¹å™¨å†…å®¹ä¸ä½ç½®æ•°æ®ã€‚</div>
      </div>
    </div>
    <div class="modal-body">
      <label for="renamebox-name-input">å®¹å™¨åç§°</label>
      <input id="renamebox-name-input" type="text" placeholder="è¯·è¾“å…¥å®¹å™¨åç§°" autocomplete="off">
      <div id="renamebox-modal-hint" class="modal-hint"></div>
      <div id="renamebox-modal-error" class="modal-error"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal" id="renamebox-cancel">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" id="renamebox-confirm">ä¿å­˜</button>
    </div>
  </div>
</div>

</body>
</html>
