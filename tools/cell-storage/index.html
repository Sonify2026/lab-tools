<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç»†èƒå†»å­˜ç®¡ç†ç³»ç»Ÿ_v2.0</title>
    <style>
        /* ========= å…¨å±€æ ·å¼å®šä¹‰ ========= */
        :root { --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f; --warning: #faad14; --bg: #f5f7fa; --dark: #001529; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); }
        
        /* ========= ä¾§è¾¹æ æ ·å¼ ========= */
        .sidebar { width: 240px; background: var(--dark); color: white; padding: 20px; display: flex; flex-direction: column; }
        .logo { font-size: 20px; font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 8px; }
        .box-list { flex: 1; overflow-y: auto; }
        .box-item { padding: 10px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 8px; background: #112a45; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .box-item:hover { border-color: #999; }
        .box-item.active { background: var(--primary); border-color: #40a9ff; }
        .box-info { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .box-tag { opacity: 0.5; font-size: 10px; margin-left: 5px; }
        .box-settings .row { display:flex; gap:10px; }
        .box-settings .field { flex:1; }
        .btn-rename-box { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:6px; background:rgba(255,255,255,0.06); color:#e6f4ff; cursor:pointer; user-select:none; }
        .btn-rename-box:hover { background:rgba(255,255,255,0.12); }
        .btn-delete-box { padding: 4px 8px; margin-left: 8px; border-radius: 4px; color: #aaa; font-weight: bold; font-size: 14px; line-height: 1; transition: 0.2s; }
        .btn-delete-box:hover { background: var(--danger); color: white; }

        /* ========= ä¸»å·¥ä½œåŒºæ ·å¼ ========= */
        .main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow: hidden; position: relative; }
        
        /* å¤´éƒ¨æœç´¢æ ä¸æŒ‰é’®ç»„ */
        .header { display: flex; align-items: center; gap: 15px; position: relative; z-index: 1000; }
        .search-wrapper { flex: 1; position: relative; }
        .search-bar { width: 100%; padding: 12px 15px; border: 1px solid #d9d9d9; border-radius: 8px; outline: none; box-sizing: border-box; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.3s; }
        .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }
        .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-height: 400px; overflow-y: auto; margin-top: 5px; display: none; }
        .search-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .search-item:hover { background: #f0f7ff; }
        .loc-tag { font-size: 11px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #666; }
        .data-btns { display: flex; gap: 10px; }
        .btn-ghost { background: white; border: 1px solid #d9d9d9; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

        /* å†…å®¹åŒºåŸŸå¸ƒå±€ */
        .content { display: flex; gap: 20px; flex: 1; overflow: hidden; }
        
        /* ç½‘æ ¼è§†å›¾å®¹å™¨ (æ”¯æŒæ¨ªå‘æ»šåŠ¨é€‚é…ä¸åŒè§„æ ¼) */
        .box-view { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: auto; flex: 1; text-align: center; display: flex; justify-content: center; align-items: flex-start;  position: relative; }
        .grid { display: grid; gap: 6px; margin: 0 auto; width: fit-content; }
        
        /* å•ä¸ªç»†èƒæ ¼å­æ ·å¼ */
        .cell {
            width: 48px; height: 48px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-size: 10px; display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start;
            padding: 4px; box-sizing: border-box;
            cursor: pointer; background: #fff; transition: all 0.2s; position: relative;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
        }
        /* å ç”¨çŠ¶æ€ (é¢œè‰²ç”±JSåŠ¨æ€ç”Ÿæˆè¦†ç›–) */
        .cell.occupied { border-color: transparent; color: #333; font-weight: 600; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
        /* äº¤äº’çŠ¶æ€: æ‚¬åœ/æ‹–æ‹½/é€‰ä¸­/é«˜äº® */
        .cell.occupied:hover { cursor: grab; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .cell.occupied:active { cursor: grabbing; }
        .cell.drag-over { border: 2px dashed var(--primary); background: #e6f7ff !important; }
        .cell.selected { border: 2px solid var(--primary) !important; box-shadow: 0 0 0 3px rgba(24,144,255,0.2); z-index: 5; transform: scale(1.05); }
        .cell.highlight-target { animation: highlight-jump 1s infinite alternate; border: 2px solid var(--warning) !important; z-index: 10; }
        @keyframes highlight-jump { 0% { transform: scale(1); box-shadow: 0 0 0px var(--warning); } 100% { transform: scale(1.15); box-shadow: 0 0 20px var(--warning); } }

        /* å³ä¾§æ“ä½œé¢æ¿æ ·å¼ */
        .panel { width: 340px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

/* ========= Notion / macOS é£æ ¼è®¾ç½®å¡ç‰‡ ========= */
.settings-toggle {
    position: absolute;
    top: 12px;
    left: 12px;
    display: none;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: #111827;
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.settings-toggle:hover { box-shadow: 0 10px 26px rgba(0,0,0,0.10); }
.settings-toggle:active { transform: translateY(1px); }

#btn-toggle-settings{ z-index: 10; }

.settings-card {
    width: min(360px, calc(100% - 24px));
    padding: 14px 14px 12px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 12px 30px rgba(0,0,0,0.10);
}
/* é¿å…è®¾ç½®å¡ç‰‡ä¸å·¦ä¸Šè§’æŒ‰é’®é‡å  */
.box-view .settings-card { margin-top: 56px; }

.settings-header {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
}
.settings-title {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 4px;
}
.settings-title h3 { margin: 0; font-size: 14px; }
.settings-title .sub {
    font-size: 12px;
    color: #6b7280;
    font-weight: 400;
}
.settings-divider { height: 1px; background: rgba(0,0,0,0.06); margin: 10px 0; }

.setting-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
    margin-bottom: 12px;
}
.setting-item label { font-size: 12px; color: #374151; font-weight: 600; margin: 0; }
.setting-hint { font-size: 12px; color: #6b7280; line-height: 1.4; margin-top: 2px; }

/* ç»Ÿä¸€è¾“å…¥æ§ä»¶æ›´åƒ macOS/Notion */
select, input[type="number"], input[type="text"] {
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.10);
    background: #fff;
    color: #111827;
    outline: none;
}
select { padding: 10px; }
select:focus, input:focus {
    border-color: rgba(24,144,255,0.55);
    box-shadow: 0 0 0 4px rgba(24,144,255,0.14);
}

.settings-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: flex-start;
    flex-wrap: wrap;
}
        input { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #d9d9d9; border-radius: 6px; box-sizing: border-box; }
        .inventory-stats { padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #91d5ff; background: #e6f7ff; transition: 0.3s; }
        .stats-danger { background: #fff1f0; border-color: #ffa39e; color: var(--danger); animation: shake 0.5s; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-save:hover { background: #40a9ff; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">ğŸ§ª ç»†èƒå†»å­˜ç®¡ç†_v2.0</div>
    <div id="box-list" class="box-list"></div>
    <div style="padding-top:15px; border-top:1px solid #333;">
        <select id="new-box-specs" style="width:100%; margin-bottom:10px; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" onchange="toggleCustomSpecFields()">
            <option value="9,9">è§„æ ¼: 9 x 9 (81æ ¼)</option>
            <option value="10,10">è§„æ ¼: 10 x 10 (100æ ¼)</option>
            <option value="8,12" selected>è§„æ ¼: 96å­”æ¿ (8è¡Œx12åˆ—)</option>
                    <option value="custom">è§„æ ¼: è‡ªå®šä¹‰...</option>
        </select>
        <div id="custom-spec-fields" style="display:none; margin-bottom:10px;">
            <div style="display:flex; gap:8px;">
                <input id="custom-rows" type="number" min="1" placeholder="è¡Œ rows" style="flex:1; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" />
                <input id="custom-cols" type="number" min="1" placeholder="åˆ— cols" style="flex:1; padding:8px; border-radius:4px; background:#112a45; color:white; border:none;" />
            </div>
            <div style="font-size:12px; color:#a8b3c7; margin-top:6px;">æç¤ºï¼šè¡ŒÃ—åˆ—å»ºè®® â‰¤ 400ï¼Œä»¥å…é¡µé¢å¡é¡¿ã€‚</div>
        </div>
        <button onclick="addNewBox()" style="width:100%; padding:10px; border-radius:6px; border:none; background:var(--primary); color:white; cursor:pointer; font-weight:bold;">+ æ–°å¢å®¹å™¨</button>
    </div>
</div>

<div class="main">
    <div class="header">
        <div class="search-wrapper">
            <input type="text" id="global-search" class="search-bar" placeholder="ğŸ” å…¨å±€æœç´¢ç»†èƒåã€ä»£æ•°..." oninput="handleGlobalSearch()">
            <div id="search-dropdown" class="search-dropdown"></div>
        </div>
        <div class="data-btns">
            <button class="btn-ghost" onclick="exportDB()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
            <button class="btn-ghost" onclick="triggerImport()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <input type="file" id="import-file" style="display:none" onchange="importDB(event)">
        </div>
    </div>

    <div class="content">
        <div class="box-view">
            <button id="btn-toggle-settings" class="btn-ghost" style="position:absolute; top:12px; left:12px; display:none;" onclick="toggleBoxSettings()">âš™ï¸ å®¹å™¨è®¾ç½®</button>
            <div id="empty-tip" style="color:#999; margin-top: 50px;">è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–æ–°å¢ä¸€ä¸ªå®¹å™¨</div>

            
<div id="box-settings" class="card settings-card" style="display:none;">
    <div class="settings-header">
        <div class="settings-title">
            <h3>ğŸ§· å®¹å™¨è®¾ç½®</h3>
            <div class="sub">ä»…å½±å“å½“å‰å®¹å™¨çš„æ˜¾ç¤ºæ–¹å¼</div>
        </div>
    </div>

    <div class="settings-divider"></div>

    <div class="setting-item">
        <label for="label-mode">æ ¼å­æ ‡å·æ˜¾ç¤º</label>
        <select id="label-mode" onchange="applyLabelMode()" style="width:100%;">
            <option value="A1">è¡Œå­—æ¯ + åˆ—æ•°å­—ï¼ˆA1, B1...ï¼‰</option>
            <option value="RC">è¡Œå·-åˆ—å·ï¼ˆ1-1, 1-2...ï¼‰</option>
            <option value="LINEAR">é¡ºåºç¼–å·ï¼ˆ1..Nï¼‰</option>
        </select>
        <div class="setting-hint">å°æŠ€å·§ï¼šæŒ‰ä½ <strong>Shift</strong> å•å‡»ä»»æ„æ ¼å­å¯ä¸ºè¯¥æ ¼è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆç•™ç©ºå¯å–æ¶ˆè¦†ç›–ï¼‰ã€‚</div>
    </div>

    <div class="settings-actions">
        <button class="btn-ghost" onclick="clearAllCustomLabels()" title="æ¸…ç©ºå½“å‰å®¹å™¨æ‰€æœ‰è‡ªå®šä¹‰æ ‡ç­¾">æ¸…ç©ºè‡ªå®šä¹‰æ ‡ç­¾</button>
    </div>
</div>

<div id="grid"<div id="grid" class="grid"></div>
        </div>

        <div class="panel">
            <div class="card">
                <h3>ğŸ“ æ ·æœ¬ç®¡ç†</h3>
                <div id="stats-area" class="inventory-stats">
                    <div style="font-size:12px;">é€‰å®šä½ç½®: <strong id="sel-count">0</strong></div>
                    <div style="margin-top:8px;">
                        å…¨åº“æ€»ä½™é‡: <span id="total-inventory" style="font-size:22px; font-weight:bold;">0</span> ç®¡
                    </div>
                </div>
                <label>ç»†èƒåç§° (Name)</label>
                <input type="text" id="cell-name" oninput="updateLiveStats()" placeholder="ä¾‹å¦‚: HEK293T">
                <label>ä»£æ•° (P)</label>
                <input type="text" id="cell-p">
                <label>å†»å­˜æ—¥æœŸ</label>
                <input type="date" id="cell-date">
                
                <button class="btn-save" onclick="saveBatch()">ä¿å­˜å¹¶å–æ¶ˆé€‰æ‹©</button>
                <button onclick="clearBatch()" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer; font-size:12px;">æ¸…ç©ºæ‰€é€‰ä½ç½® (å‡ºåº“)</button>
            </div>

            <div class="card">
                <h3 style="color:var(--danger)">âš ï¸ ä½åº“å­˜é¢„è­¦</h3>
                <div id="global-warning-list" style="max-height:180px; overflow-y:auto; font-size:13px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // ========= å…¨å±€å˜é‡ä¸åˆå§‹åŒ– =========
    // ä½¿ç”¨æ­£å¼çš„ v1.0 å­˜å‚¨é”®å
    const STORAGE_KEY = 'cell_storage_v1_db';
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { boxes: {} };
    let currentBoxId = null;
    let selectedPositions = new Set();
    let searchHighlightPos = null; // ç”¨äºæœç´¢è·³è½¬åçš„é«˜äº®
    let draggedItemPos = null;     // ç”¨äºæ‹–æ‹½è®°å½•èµ·å§‹ä½ç½®

    function init() {
        // æ•°æ®ç»“æ„æ ‡å‡†åŒ–æ£€æŸ¥ (ç¡®ä¿æ—§æ•°æ®åŒ…å« rows/cols å±æ€§)
        let dataNormalized = false;
        Object.values(db.boxes).forEach(box => {
            if (box.size && !box.rows) {
                box.rows = box.size;
                box.cols = box.size;
                dataNormalized = true;
            }
        });
        if (dataNormalized) save();

        // v1.1 æ•°æ®ç»“æ„è¡¥å…¨ï¼šæ ‡å·æ¨¡å¼/è‡ªå®šä¹‰æ ‡ç­¾/è¡Œèµ·å§‹å­—æ¯/ç¼ºå¤±å­—æ®µ
        let v11Normalized = false;
        Object.values(db.boxes).forEach(box => {
            if (!box.vials) { box.vials = {}; v11Normalized = true; }
            if (!box.labelMode) { box.labelMode = 'A1'; v11Normalized = true; }
            if (!box.customLabels) { box.customLabels = {}; v11Normalized = true; }
            if (box.labelMode === 'CUSTOM') { box.labelMode = 'A1'; v11Normalized = true; }
        });
        if (v11Normalized) save();
        
        renderBoxList();
        updateWarningBoard();
        // å¦‚æœæ²¡æœ‰å®¹å™¨ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        if (Object.keys(db.boxes).length === 0) document.getElementById('empty-tip').style.display = 'block';
    }

    // ========= æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼šå®¹å™¨ç®¡ç† =========
    

    function toggleCustomSpecFields() {
        const sel = document.getElementById('new-box-specs');
        const wrap = document.getElementById('custom-spec-fields');
        if (!sel || !wrap) return;
        wrap.style.display = (sel.value === 'custom') ? 'block' : 'none';
    }

function addNewBox() {
        const name = prompt("è¯·è¾“å…¥å®¹å™¨åç§° (ä¾‹å¦‚: 96å­”æ¿-1):"); 
        if (!name) return;

        const val = document.getElementById('new-box-specs').value;
        let rows, cols;

        if (val === 'custom') {
            const r = parseInt(document.getElementById('custom-rows').value, 10);
            const c = parseInt(document.getElementById('custom-cols').value, 10);
            if (!Number.isFinite(r) || !Number.isFinite(c) || r < 1 || c < 1) {
                alert("è¯·åœ¨ä¸‹æ–¹è¾“å…¥è‡ªå®šä¹‰è¡Œ/åˆ—ï¼ˆæ­£æ•´æ•°ï¼‰");
                return;
            }
            // åˆç†ä¸Šé™ï¼šé¿å…æ¸²æŸ“å¡é¡¿ï¼›å¦‚éœ€æ›´å¤§å¯åç»­åšç¼©æ”¾/åˆ†é¡µ
            if (r * c > 400) {
                alert("æ ¼å­æ•°é‡è¿‡å¤šï¼ˆ>400ï¼‰å¯èƒ½å½±å“æ€§èƒ½ï¼Œè¯·é™ä½è¡Œåˆ—æˆ–åç»­å†åšç¼©æ”¾æ”¯æŒã€‚");
                return;
            }
            rows = r; cols = c;
        } else {
            // è§£æä¸‹æ‹‰èœå•ä¸­çš„è¡Œåˆ—è§„æ ¼å€¼ "rows,cols"
            const specs = val.split(',').map(Number);
            rows = specs[0]; cols = specs[1];
        }

        const id = 'box_' + Date.now();
        db.boxes[id] = { 
            name: name.trim(), 
            rows, cols, 
            vials: {}, 
            labelMode: 'A1',
            customLabels: {},
            };
        save(); 
        renderBoxList(); 
        switchBox(id);
    }


    function renameBox(id, event) {
        event.stopPropagation();
        const old = db.boxes[id].name;
        const next = prompt('è¯·è¾“å…¥æ–°çš„å®¹å™¨åç§°ï¼š', old);
        if (!next) return;
        db.boxes[id].name = next.trim();
        save(); renderBoxList(); updateWarningBoard();
    }

    function deleteBox(id, event) {
        event.stopPropagation(); // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘åˆ‡æ¢ç›’å­
        if (!confirm(`âš ï¸ é¢„è­¦\n\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤å®¹å™¨ã€${db.boxes[id].name}ã€‘åŠå…¶å†…æ‰€æœ‰æ ·æœ¬å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) return;
        
        delete db.boxes[id];
        save();
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„ç›’å­ï¼Œé‡ç½®è§†å›¾
        if (currentBoxId === id) {
            currentBoxId = null;
            document.getElementById('grid').innerHTML = '';
            document.getElementById('empty-tip').style.display = 'block';
            updatePanel();
        }
        renderBoxList();
        updateWarningBoard();
    }

    
function renderBoxList() {
        const list = document.getElementById('box-list'); list.innerHTML = '';
        Object.keys(db.boxes).forEach(id => {
            const b = db.boxes[id];
            const div = document.createElement('div'); 
            div.className = `box-item ${id === currentBoxId ? 'active' : ''}`;
            // æ¸²æŸ“åˆ—è¡¨é¡¹ï¼šåŒ…å«åç§°ã€è§„æ ¼æ ‡ç­¾ã€é‡å‘½åå’Œåˆ é™¤æŒ‰é’®
            div.innerHTML = `
                <div class="box-info">${b.name} <span class="box-tag">${b.rows}x${b.cols}</span></div>
                <div style="display:flex; gap:6px;">
                    <div class="btn-rename-box" onclick="renameBox('${id}', event)" title="é‡å‘½å">âœ</div>
                    <div class="btn-delete-box" onclick="deleteBox('${id}', event)" title="åˆ é™¤æ­¤å®¹å™¨">Ã—</div>
                </div>
            `;
            div.onclick = () => { searchHighlightPos = null; switchBox(id); }; 
            list.appendChild(div);
        });
    }


    function switchBox(id) {
        currentBoxId = id; selectedPositions.clear();
        document.getElementById('empty-tip').style.display = 'none';
        renderBoxSettings();
        renderGrid(); renderBoxList(); updatePanel();
    }

    // ========= æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼šç½‘æ ¼æ¸²æŸ“ä¸äº¤äº’ =========
    
    // ========= v2.0ï¼šæ ¼å­æ ‡å·æ˜ å°„ (å†…éƒ¨ä»ä½¿ç”¨ r-c ä½œä¸ºä½ç½®é”®) =========
    function posToLabel(pos, box) {
        if (box && box.customLabels && box.customLabels[pos]) return box.customLabels[pos];
        const [rStr, cStr] = pos.split('-');
        const r = parseInt(rStr, 10), c = parseInt(cStr, 10);

        const mode = (box && box.labelMode) ? box.labelMode : 'RC';
        switch (mode) {
            case 'A1': {
                const start = String(box.rowAlphabetStart || 'A').toUpperCase().charCodeAt(0);
                const rowCharCode = start + (r - 1);
                // ç®€åŒ–ï¼šä»…æ”¯æŒ A-Zï¼›è‹¥è¶…å‡ºåˆ™å›é€€ä¸º RC æ˜¾ç¤º
                if (rowCharCode > 90) return `${r}-${c}`;
                const rowChar = String.fromCharCode(rowCharCode);
                return `${rowChar}${c}`;
            }
            case 'LINEAR': {
                const idx = (r - 1) * box.cols + c; // 1..N
                return String(idx);
            }            case 'RC':
            default:
                return `${r}-${c}`;
        }
    }

    function labelToPos(label, box) {
        const t = String(label || '').trim();
        if (!t || !box) return null;

        // å…ˆåæŸ¥è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆå…è®¸ä»»æ„æ–‡æœ¬ï¼‰
        if (box.customLabels) {
            for (const [pos, v] of Object.entries(box.customLabels)) {
                if (String(v).trim() === t) return pos;
            }
        }

        const mode = box.labelMode || 'RC';

        if (mode === 'A1') {
            const m = t.match(/^([A-Za-z])\s*(\d+)$/);
            if (!m) return null;
            const rowChar = m[1].toUpperCase();
            const col = parseInt(m[2], 10);
            const row = rowChar.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
            if (row < 1 || row > box.rows || col < 1 || col > box.cols) return null;
            return `${row}-${col}`;
        }

        if (mode === 'LINEAR') {
            const idx = parseInt(t, 10);
            if (!Number.isFinite(idx) || idx < 1 || idx > box.rows * box.cols) return null;
            const row = Math.floor((idx - 1) / box.cols) + 1;
            const col = ((idx - 1) % box.cols) + 1;
            return `${row}-${col}`;
        }

        // RC fallback
        if (/^\d+\s*-\s*\d+$/.test(t)) {
            const [r, c] = t.split('-').map(s => parseInt(s.trim(), 10));
            if (r < 1 || r > box.rows || c < 1 || c > box.cols) return null;
            return `${r}-${c}`;
        }
        return null;
    }

    function renderBoxSettings() {
        const wrap = document.getElementById('box-settings');
        if (!wrap) return;
        if (!currentBoxId || !db.boxes[currentBoxId]) { wrap.style.display = 'none'; const btn = document.getElementById('btn-toggle-settings'); if (btn) btn.style.display = 'none'; return; }
        const box = db.boxes[currentBoxId];
        wrap.style.display = 'none';
        const btn = document.getElementById('btn-toggle-settings');
        if (btn) { btn.style.display = 'inline-flex'; btn.innerText = 'âš™ï¸ å®¹å™¨è®¾ç½®'; }
        document.getElementById('label-mode').value = box.labelMode || 'A1';
    }

    
    function toggleBoxSettings(force) {
        const panel = document.getElementById('box-settings');
        if (!panel) return;
        const btn = document.getElementById('btn-toggle-settings');
        const wantShow = (typeof force === 'boolean') ? force : (panel.style.display === 'none');
        panel.style.display = wantShow ? 'block' : 'none';
        if (btn) btn.innerText = wantShow ? 'âœ– å…³é—­è®¾ç½®' : 'âš™ï¸ å®¹å™¨è®¾ç½®';
        // è®©ç½‘æ ¼ä¸ä¼šè¢«è®¾ç½®é¢æ¿æ’‘å¼€å¤ªå¤šï¼šè®¾ç½®æ‰“å¼€æ—¶æŠŠé¢æ¿æ”¾åœ¨ä¸Šæ–¹å³å¯
    }

function applyLabelMode() {
        if (!currentBoxId) return;
        const box = db.boxes[currentBoxId];
        box.labelMode = document.getElementById('label-mode').value;
        save(); 
        renderGrid();
    }

    function clearAllCustomLabels() {
        if (!currentBoxId) return;
        const box = db.boxes[currentBoxId];
        if (!box.customLabels || Object.keys(box.customLabels).length === 0) return;
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å®¹å™¨æ‰€æœ‰è‡ªå®šä¹‰æ ‡ç­¾å—ï¼Ÿï¼ˆæ ·æœ¬æ•°æ®ä¸å—å½±å“ï¼‰')) return;
        box.customLabels = {};
        save(); renderGrid(); renderBoxSettings();
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        if (!currentBoxId) return;
        const box = db.boxes[currentBoxId];
        // æ ¹æ®å®¹å™¨åˆ—æ•°åŠ¨æ€è®¾ç½®ç½‘æ ¼å¸ƒå±€
        grid.style.gridTemplateColumns = `repeat(${box.cols}, 48px)`;

        // åŒé‡å¾ªç¯æ¸²æŸ“æ‰€æœ‰æ ¼å­
        for (let r = 1; r <= box.rows; r++) {
            for (let c = 1; c <= box.cols; c++) {
                const pos = `${r}-${c}`;
                const v = box.vials[pos];
                const el = document.createElement('div');
                el.id = `cell-${pos}`;
                el.className = 'cell';

                if (v && v.name) {
                    // æ¸²æŸ“å·²å ç”¨æ ¼å­
                    el.classList.add('occupied'); 
                    el.style.backgroundColor = stringToHslColor(v.name); // åº”ç”¨åŠ¨æ€é¢œè‰²
                    const label = posToLabel(pos, box);
                    el.title = `ä½ç½®: ${label} (${pos})\nåç§°: ${v.name}\nä»£æ•°: ${v.p || '-'}\næ—¥æœŸ: ${v.date || '-'}`; // æ‚¬åœæç¤º
                    el.innerHTML = `<strong style="font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100%; text-align:left;">${v.name}</strong><span style="font-size:8px; opacity:0.8">${v.p || ''}</span>`;
                    // å¯ç”¨æ‹–æ‹½èµ·å§‹
                    el.setAttribute('draggable', 'true');
                    el.addEventListener('dragstart', (e) => handleDragStart(e, pos)); 
                    el.addEventListener('dragend', handleDragEnd);
                } else {
                    // æ¸²æŸ“ç©ºæ ¼å­
                    el.innerText = posToLabel(pos, box);
                    // å¯ç”¨æ‹–æ‹½æ”¾ç½®ç›®æ ‡
                    el.addEventListener('dragover', handleDragOver);
                    el.addEventListener('dragenter', function() { this.classList.add('drag-over'); });
                    el.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
                    el.addEventListener('drop', (e) => handleDrop(e, pos));
                }

                // åº”ç”¨é€‰ä¸­å’Œé«˜äº®çŠ¶æ€
                if (selectedPositions.has(pos)) el.classList.add('selected');
                if (searchHighlightPos === pos) el.classList.add('highlight-target');
                
                // ç‚¹å‡»äº‹ä»¶å¤„ç†
                el.addEventListener('click', (e) => {
                    searchHighlightPos = null;
                    // Shift+ç‚¹å‡»ï¼šè®¾ç½®è¯¥æ ¼çš„è‡ªå®šä¹‰æ ‡ç­¾è¦†ç›–
                    if (e.shiftKey) {
                        const current = (box.customLabels && box.customLabels[pos]) || posToLabel(pos, box);
                        const next = prompt(`ä¸ºè¯¥æ ¼è®¾ç½®æ˜¾ç¤ºæ ‡ç­¾ï¼ˆç•™ç©º=å–æ¶ˆè‡ªå®šä¹‰è¦†ç›–ï¼‰\nå†…éƒ¨ä½ç½®é”®ä»ä¸º ${pos}`, current);
                        if (next === null) return;
                        box.customLabels = box.customLabels || {};
                        if (next.trim() === '') delete box.customLabels[pos];
                        else box.customLabels[pos] = next.trim();
                        save(); renderGrid(); renderBoxSettings();
                        return;
                    }
                    toggleSelect(pos);
                });
                grid.appendChild(el);
            }
        }
    }

    // ========= è¾…åŠ©åŠŸèƒ½æ¨¡å—ï¼šé¢œè‰²ç”Ÿæˆ =========
    // æ ¹æ®å­—ç¬¦ä¸²ç”Ÿæˆå”¯ä¸€çš„æŸ”å’Œ HSL é¢œè‰²
    function stringToHslColor(str) { 
        let hash = 0; 
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); 
        return `hsl(${hash % 360}, 60%, 88%)`; 
    }

    // ========= è¾…åŠ©åŠŸèƒ½æ¨¡å—ï¼šæ‹–æ‹½é€»è¾‘ (Drag & Drop) =========
    function handleDragStart(e, pos) { 
        draggedItemPos = pos; 
        e.dataTransfer.effectAllowed = 'move'; 
        e.target.style.opacity = '0.5'; 
    }
    function handleDragEnd(e) { 
        e.target.style.opacity = '1'; 
        document.querySelectorAll('.cell').forEach(el => el.classList.remove('drag-over')); 
    }
    function handleDragOver(e) { 
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move'; 
        return false; 
    }
    function handleDrop(e, targetPos) { 
        e.stopPropagation(); 
        if (draggedItemPos === targetPos) return; 
        const box = db.boxes[currentBoxId]; 
        if (box.vials[targetPos]) { alert("æ— æ³•ç§»åŠ¨ï¼šç›®æ ‡ä½ç½®å·²æœ‰æ ·æœ¬ã€‚è¯·å…ˆæ¸…ç©ºç›®æ ‡ä½ç½®ã€‚"); return; } 
        // æ‰§è¡Œç§»åŠ¨æ“ä½œ
        box.vials[targetPos] = box.vials[draggedItemPos]; 
        delete box.vials[draggedItemPos]; 
        save(); renderGrid(); 
        // å¦‚æœç§»åŠ¨çš„æ˜¯é€‰ä¸­çš„æ ¼å­ï¼Œæ¸…ç†é€‰ä¸­çŠ¶æ€
        if (selectedPositions.has(draggedItemPos)) { selectedPositions.clear(); updatePanel(); } 
    }

    // ========= è¾…åŠ©åŠŸèƒ½æ¨¡å—ï¼šé¢æ¿äº¤äº’ä¸æ•°æ®æ›´æ–° =========
    function toggleSelect(pos) { 
        if (selectedPositions.has(pos)) selectedPositions.delete(pos); 
        else selectedPositions.add(pos); 
        renderGrid(); updatePanel(); 
    }
    function updatePanel() {
        document.getElementById('sel-count').innerText = selectedPositions.size;
        // å¦‚æœä»…é€‰ä¸­ä¸€ä¸ªï¼Œå›æ˜¾å…¶æ•°æ®
        if (selectedPositions.size === 1) {
            const pos = Array.from(selectedPositions)[0];
            const data = db.boxes[currentBoxId].vials[pos] || {};
            document.getElementById('cell-name').value = data.name || '';
            document.getElementById('cell-p').value = data.p || '';
            document.getElementById('cell-date').value = data.date || '';
        }
        updateLiveStats();
    }
    // å®æ—¶è®¡ç®—å…¨åº“å­˜é‡å¹¶è§¦å‘é¢„è­¦æ ·å¼
    function updateLiveStats() {
        const name = document.getElementById('cell-name').value.trim().toLowerCase();
        const totalSpan = document.getElementById('total-inventory');
        const statsArea = document.getElementById('stats-area');
        if (!name) { totalSpan.innerText = '0'; statsArea.classList.remove('stats-danger'); return; }
        let count = 0;
        Object.values(db.boxes).forEach(b => {
            Object.values(b.vials).forEach(v => { if (v.name && v.name.toLowerCase() === name) count++; });
        });
        totalSpan.innerText = count;
        if (count > 0 && count <= 3) statsArea.classList.add('stats-danger'); else statsArea.classList.remove('stats-danger');
    }
    
    // ========= æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼šæ•°æ®å­˜å– (å…¥åº“/å‡ºåº“) =========
    function saveBatch() {
        if (!currentBoxId || selectedPositions.size === 0) return alert("è¯·å…ˆé€‰æ‹©æ ¼å­");
        const name = document.getElementById('cell-name').value.trim(); if (!name) return alert("ç»†èƒåç§°å¿…å¡«");
        const data = { name, p: document.getElementById('cell-p').value, date: document.getElementById('cell-date').value };
        selectedPositions.forEach(pos => db.boxes[currentBoxId].vials[pos] = {...data});
        selectedPositions.clear(); // ä¿å­˜åè‡ªåŠ¨å–æ¶ˆé€‰æ‹©
        save(); renderGrid(); updatePanel(); updateWarningBoard();
    }
    function clearBatch() {
        if (!selectedPositions.size || !confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€é€‰ä½ç½®å—ï¼Ÿ(å‡ºåº“åŠ¨ä½œ)")) return;
        selectedPositions.forEach(pos => delete db.boxes[currentBoxId].vials[pos]);
        selectedPositions.clear(); // å‡ºåº“åè‡ªåŠ¨å–æ¶ˆé€‰æ‹©
        save(); renderGrid(); updatePanel(); updateWarningBoard();
    }

    // ========= è¾…åŠ©åŠŸèƒ½æ¨¡å—ï¼šå…¨å±€æœç´¢ä¸é¢„è­¦ =========
    function handleGlobalSearch() {
        const term = document.getElementById('global-search').value.toLowerCase().trim();
        const dropdown = document.getElementById('search-dropdown');
        if (!term) { dropdown.style.display = 'none'; return; }
        let matches = [];
        Object.keys(db.boxes).forEach(boxId => {
            const box = db.boxes[boxId];
            Object.keys(box.vials).forEach(pos => {
                const v = box.vials[pos];
                if (v.name.toLowerCase().includes(term)) matches.push({ boxId, boxName: box.name, pos, label: posToLabel(pos, box), name: v.name, p: v.p });
            });
        });
        dropdown.innerHTML = matches.length ? matches.map(m => `
            <div class="search-item" onclick="jumpToVial('${m.boxId}', '${m.pos}')">
                <div><strong>${m.name}</strong> <small style="color:#888">(${m.p||'-'})</small></div>
                <div class="loc-tag">${m.boxName} [${m.pos}]</div>
            </div>`).join('') : '<div style="padding:15px; color:#999;">æœªæ‰¾åˆ°åŒ¹é…æ ·æœ¬</div>';
        dropdown.style.display = 'block';
    }
    // è·³è½¬å¹¶é«˜äº®ç›®æ ‡æ ¼å­
    function jumpToVial(boxId, pos) {
        document.getElementById('search-dropdown').style.display = 'none';
        document.getElementById('global-search').value = '';
        searchHighlightPos = pos; switchBox(boxId);
        setTimeout(() => { const el = document.getElementById(`cell-${pos}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200);
    }
    // æ›´æ–°å…¨å±€ä½åº“å­˜é¢„è­¦çœ‹æ¿
    function updateWarningBoard() {
        const board = document.getElementById('global-warning-list');
        let counts = {};
        Object.values(db.boxes).forEach(b => Object.values(b.vials).forEach(v => { if (v.name) counts[v.name] = (counts[v.name] || 0) + 1; }));
        const lows = Object.keys(counts).filter(n => counts[n] <= 3);
        board.innerHTML = lows.length ? lows.map(n => `
            <div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <span>${n}</span><b style="color:var(--danger)">ä½™${counts[n]}</b>
            </div>`).join('') : '<div style="color:#ccc; text-align:center;">âœ… åº“å­˜å……è¶³</div>';
    }

    // ========= æ•°æ®æŒä¹…åŒ–ä¸å¯¼å…¥å¯¼å‡º =========
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    
    function exportDB() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: 'application/json'}));
        a.download = `Cell_Storage_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
    
    function triggerImport() { document.getElementById('import-file').click(); }
    
    function importDB(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const data = JSON.parse(ev.target.result);
                if (data.boxes) { db = data; init(); save(); alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼"); }
                else alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œéæœ‰æ•ˆçš„å¤‡ä»½æ–‡ä»¶ã€‚");
            } catch (err) { alert("å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåã€‚"); }
        };
        reader.readAsText(e.target.files[0]);
        e.target.value = ''; // é‡ç½® input file ä»¥ä¾¿ä¸‹æ¬¡é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢ä¸‹æ‹‰æ¡†
    document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) document.getElementById('search-dropdown').style.display = 'none'; });
    
    // å¯åŠ¨åº”ç”¨
    toggleCustomSpecFields();
    init();
</script>
</body>
</html>
