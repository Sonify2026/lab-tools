## 1. 产品概述

**离线密码库**是一款在浏览器本地运行的密码/密钥管理工具，所有数据保存在本机浏览器的 **IndexedDB** 中，并通过 **WebCrypto（PBKDF2 + AES-GCM）** 加密；支持将整个密码库以“加密容器”的方式导出/导入，便于离线备份与迁移。

### 关键特性

- **全离线**：不依赖第三方 CDN，建议离线使用。
- **主密码解锁**：主密码用于派生密钥，**不可找回**。
- **自动锁定**：默认闲置 **5 分钟**自动锁定（可改代码参数）。
- **“最小明文驻留”设计**：列表缓存仅保留非敏感字段；只有选中条目时才解密完整内容（含密码/备注）。
---
## 2. 运行环境与准备

### 支持环境

- 推荐：Chrome / Edge / Safari（对某些“密码掩码显示”体验更好）
- Firefox 也可用，但由于浏览器对 `text-security` 支持差异，密码显示/隐藏实现会走兼容逻辑。

### 使用前重要提示

- **主密码忘记 = 数据不可解密**（没有找回功能）。
- 浏览器环境无法保证内存绝对安全：解锁期间数据可能被调试工具读取，属于浏览器运行环境的天然限制。
---
## 3. 打开方式

1. 点击 `打开工具` 按钮即可。
2. 首次打开时，右上角状态显示 **“🔒 未解锁”**。
---
## 4. 第一次使用：创建新密码库

首次使用时，本机浏览器尚无密码库元数据（meta），系统会引导你创建新库：

1. 打开解锁/创建弹窗（常见触发方式：界面引导；或在未解锁状态点击“新建条目”会提示进入解锁流程）。
2. 选择 **“创建新库”**，输入主密码并再次确认。
3. 创建完成后，库的元信息会写入 IndexedDB（包含 salt、KDF 参数、被主密钥包裹的 vaultKey 等）。

> 强烈建议：主密码使用高强度、可长期记忆/妥善保管的方案；并立即做一次“导出（加密）”备份（见第 9 节）。
---
## 5. 解锁、锁定与会话管理

### 5.1 解锁密码库

1. 点击弹窗的 **“解锁”**，输入主密码。
2. 工具会执行：主密码 → PBKDF2 派生 masterKey → 解包 vaultKey → 加载条目索引缓存。

解锁后右上角会显示 **“🔓 已解锁（闲置自动锁定）”**。

### 5.2 手动锁定

点击右上角 **“锁定”** 按钮即可立即锁定。

锁定会清空：
- masterKey / vaultKey 引用
- 列表缓存 itemsCache
- 当前正在查看的敏感字段（密码、备注、绑定信息、会员信息等）

### 5.3 自动锁定（闲置超时）

- 默认 **5 分钟无操作自动锁定**。
- 系统会监听点击、键盘、鼠标移动、滚动、触摸等事件来刷新计时器。
---
## 6. 界面结构说明（从左到右）

### 6.1 顶部工具栏
- 状态：🔒 未解锁 / 🔓 已解锁
- 按钮：**锁定 / 导出（加密） / 导入（加密）**

### 6.2 左侧：过滤、常用操作、统计

- **过滤**
    - 类型下拉（全部/具体类型）
    - 标签过滤（逗号分隔）
- **常用操作**
    - ➕ 新建条目
    - 🎲 生成密码
- **统计**
    - 条目数、类型数、是否锁定

### 6.3 中间：列表与搜索

- 搜索框：可按 **标题 / 账号 / URL / 标签 / 备注**等关键字检索（实际搜索基于索引字段，避免解密全部敏感内容）。
- ↻ 刷新：重新加载索引缓存并重绘列表。

### 6.4 右侧：详情/编辑区（核心）

字段分为几组：
- 基本信息：类型、标题、账号、URL、标签
- 绑定信息（可选）：绑定邮箱/手机号/微信/QQ
- 会员信息（可选）：到期日期、会员备注
- 密码/密钥：显示/隐藏、复制账号、复制密码
- 备注：自由文本（提示：不建议写安全问题答案等高敏信息）
- 操作：保存 / 取消 / 删除
---
## 7. 条目管理（新增 / 编辑 / 删除）

### 7.1 新建条目

1. 解锁后，点击左侧 **“➕ 新建条目”**。
2. 在右侧填写信息（至少填写 **标题/账号/URL** 之一，否则无法保存）。
3. 点击 **“💾 保存”**。保存时会用 vaultKey 对完整条目 JSON 做 AES-GCM 加密，并写入 IndexedDB。

**条目类型**来自内置类型列表（如：网站账号、邮箱、服务器/SSH、API Key、数据库、Wi-Fi 等）。

### 7.2 编辑条目

1. 在中间列表点击某条目。
2. 工具会仅对该条目进行解密，填充右侧编辑区（密码/备注/绑定信息/会员信息会随条目加载）。
3. 修改后点击 **保存**。

### 7.3 取消修改

- 点击 **“取消”** 会撤销未保存修改：若当前有选中条目，会从数据库重新读取该条目以回滚（避免使用内存中的旧敏感数据）。

### 7.4 删除条目

- 选中条目后点击 **“🗑 删除”**（按钮在未选中时不可用）。

> 备注：你提供的文件在“删除逻辑”后半段被截断，但从已有代码可确认存在删除入口与 IndexedDB 删除方法封装。

## 8. 密码显示、自动隐藏与复制剪贴板

### 8.1 密码显示/隐藏

- 默认密码输入框为“掩码隐藏”状态（通过 CSS 掩码或 type=password 兼容实现）。
- 点击 **“👁 显示”** 后会显示明文，并开启 **15 秒倒计时**，到点自动隐藏。
- 再次点击按钮会立即隐藏（按钮文案会在“显示/隐藏”间切换）。

### 8.2 复制账号 / 复制密码

- 右侧提供 **“复制账号 / 复制密码”**。
- 复制优先使用 `navigator.clipboard.writeText`；若失败，会走 textarea + `execCommand("copy")` 的 fallback。
- 工具会尝试在 **30 秒后**用空字符串覆盖剪贴板（best-effort，可能被系统/浏览器拒绝）。
- UI 也提示：部分平台无法自动清空剪贴板属于系统限制，复制后应尽快粘贴到可信窗口。

## 9. 导入/导出（加密容器备份与迁移）

### 9.1 导出（加密）

点击右上角 **“导出（加密）”**：
- 导出内容包含：
    - `meta`（加密元信息：salt、PBKDF2 参数、wrappedVaultKey 等）
    - `items`（每条条目的密文 payload）

- 导出文件名形如：`vault-YYYY-MM-DDTHH-mm-ss...vault.json`（时间戳会替换掉冒号与点）。
- 重要：导出文件仍然是**加密态**，但一旦泄露仍有风险（取决于主密码强度与离线攻击成本）。UI 也提示“导出文件建议另行备份，并注意泄露风险（虽然是加密的）”。

### 9.2 导入（加密）

点击右上角 **“导入（加密）”** 选择 `.vault/.json` 文件：

导入逻辑要点：

- **大小上限 20MB**：超过会拒绝导入，避免浏览器卡死。
- **条目数软阈值 10000**：超过会弹确认框提醒可能卡顿。
- 会校验导入 JSON 的 `format/version/schema_version/kdf/iterations/salt/wrappedVaultKey/IV` 等结构合法性，异常会拒绝。
- 导入时会：
    1. 写入 meta
    2. 清空本地 items store
    3. 写入导入文件中的密文条目
    4. 导入后立即锁定，提示“请解锁”并要求使用“对应主密码”。


> **导入成功 ≠ 立刻可读**。你必须用与该备份匹配的主密码解锁；若主密码不匹配，将出现“部分条目无法解密”等提示。

## 10. 搜索、过滤与列表显示逻辑

### 10.1 搜索

- 搜索框提示为“搜索：标题 / 账号 / URL / 标签 / 备注”。
- 实际实现为：对**索引字段**拼接成 haystack 后做 `includes` 匹配（不解密 notes/secret 来做全库搜索）。

### 10.2 过滤

- 类型过滤：左侧“类型”下拉框（全部/各类型）。
- 标签过滤：输入逗号分隔标签；系统会 normalize（trim、去空、去重）。

### 10.3 列表中的会员到期提示

如果条目填写了“会员到期日期”，列表右侧会显示：
- 已过期 / 30 天内到期 / 到期日等标签提示。

## 11. 密码生成器

点击左侧 **“🎲 生成密码”**：
- 默认生成长度 **20** 的随机密码。
- 字符集包含：去易混淆字符的大小写字母与数字（如跳过 0/O、1/l 等）+ 常见符号。
- 生成后会写入“密码/密钥”输入框，并保持隐藏显示策略（不会自动明文展示）。

## 12. 快捷键与提示信息

- 在未解锁时，列表区域会提示：按 **Ctrl/Cmd + L** 解锁。

## 13. 常见问题与排错

### Q1：导入成功但解锁后提示“部分条目无法解密”

可能原因：

- 主密码不匹配（最常见）
- 导入文件被损坏/被修改
- 浏览器存储异常

程序会统计解密失败数量并提示“可能密码不匹配或数据损坏”。

### Q2：点击“复制密码”失败

- 浏览器可能禁止剪贴板 API（尤其是非 HTTPS 场景、权限设置、或某些安全策略）。
- 工具会尝试 fallback 复制；若仍失败会 toast 提示“浏览器可能禁止剪贴板访问”。

### Q3：密码显示/隐藏行为在 Firefox 不一样

这是预期行为：工具会根据浏览器是否支持 `text-security` 来选择“CSS 掩码”或“切换 input type”兼容逻辑。

### Q4：为什么会自动锁定？

默认闲置 5 分钟会触发自动锁定，用于降低长时间明文驻留风险。

## 14. 安全使用建议

- **尽量离线使用**，避免不必要的网络环境与扩展干扰。
- **解锁后即用即锁**：敏感操作（复制/查看）完成后建议手动锁定。
- **定期导出加密备份**，并将备份文件放入你可信的离线备份介质（U 盘/加密盘/冷备份）。
- **不要在备注里写安全问题答案**等“可直接被利用”的敏感信息。
